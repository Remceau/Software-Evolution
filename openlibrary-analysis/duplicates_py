<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="simian.xsl" type="text/xsl"?>
<!--
Simian Similarity Analyzer 4.0.0 - https://simian.quandarypeak.com
Copyright (c) 2023 Quandary Peak Research. All rights reserved.
Subject to the Quandary Peak Academic Software License.
-->
<simian version="4.0.0">
    <check failOnDuplication="true" ignoreCharacterCase="true" ignoreCurlyBraces="true" ignoreIdentifierCase="true" ignoreModifiers="true" ignoreStringCase="true" reportDuplicateText="true" threshold="4">
        <set lineCount="4" fingerprint="a794f3b4f5c7fe4fe3689f283408157d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/imports.py" startLineNumber="415" endLineNumber="418"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/imports.py" startLineNumber="352" endLineNumber="355"/>
            <text>
<![CDATA[            )
        except UndefinedTable:
            logger.exception("Database table import_item may not exist on localhost")
            return []
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="1744565928c57f6ce74490e62d115739">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/i18n/__init__.py" startLineNumber="187" endLineNumber="191"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/i18n/__init__.py" startLineNumber="172" endLineNumber="176"/>
            <text>
<![CDATA[    for locale in locales_to_update:
        po_path = os.path.join(root, locale, 'messages.po')
        mo_path = os.path.join(root, locale, 'messages.mo')

        if os.path.exists(po_path):
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="4bb319f9552fd9a9addd1897573eb7ac">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/utils/__init__.py" startLineNumber="343" endLineNumber="346"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/utils/__init__.py" startLineNumber="304" endLineNumber="307"/>
            <text>
<![CDATA[        return any(
            record.split(":")[0] in BOOKSELLERS_WITH_ADDITIONAL_VALIDATION
            for record in rec.get('source_records', [])
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="4e8b39a0ccb4c8be29b22b81bd568835">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/checkins.py" startLineNumber="236" endLineNumber="240"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/checkins.py" startLineNumber="53" endLineNumber="57"/>
            <text>
<![CDATA[    user = get_current_user()
    if not user:
        return None

    username = user['key'].split('/')[-1]
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="de6497cf3e8f7993de6ee29968e8c86c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="287" endLineNumber="290"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="211" endLineNumber="214"/>
            <text>
<![CDATA[        w = make_work()
        d = WorkSolrBuilder(
            work=w,
            editions=[
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="b24beafb19979a00a54c6d9997e1f969">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/utils.py" startLineNumber="402" endLineNumber="405"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/utils.py" startLineNumber="365" endLineNumber="368"/>
            <text>
<![CDATA[    Revision is taken as argument to make sure a new cache entry is used when a new revision of the page is created.
    """
    if 'env' not in web.ctx:
        delegate.fakeload()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="d40fd92298ef0067d5ecacefb19062b9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="184" endLineNumber="187"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/ia.py" startLineNumber="155" endLineNumber="158"/>
            <text>
<![CDATA[                "revision": 1,
                "created": timestamp,
                "last_modified": timestamp,
            }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="8bb1e48d4579ce2677c2e3abd05d9c2f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/vendors.py" startLineNumber="327" endLineNumber="330"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/vendors.py" startLineNumber="291" endLineNumber="294"/>
            <text>
<![CDATA[    :param bool high_priority: Priority in the import queue. High priority
           goes to the front of the queue.
    :return: A single book item's metadata, or None.
    """
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="60151f94e3306cc71b9e35229659e25f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="244" endLineNumber="247"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/code.py" startLineNumber="479" endLineNumber="482"/>
            <text>
<![CDATA[            'subject',
            'place',
            'person',
            'time',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e34da30b2194f279290e2528670ea0b0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="130" endLineNumber="133"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="93" endLineNumber="96"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="78" endLineNumber="81"/>
            <text>
<![CDATA[            'multi_choice': False,
            'order': [1, 2, 3, 4, 5],
            'values': [
                {'id': 1, 'name': 'Not applicable'},
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="58ca4e455ab8b4c7b6955b097e742fa4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="792" endLineNumber="796"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="784" endLineNumber="788"/>
            <text>
<![CDATA[        if since:
            query += " WHERE created >= $since"
        return oldb.query(query, vars={'since': since})[0]['count']

    @classmethod
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="c795585009eff69280e1f003a056ffbc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_i18n.py" startLineNumber="76" endLineNumber="79"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_i18n.py" startLineNumber="54" endLineNumber="57"/>
            <text>
<![CDATA[        web.ctx.lang = 'fr'
        self.d.init(
            'fr',
            {
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="b28499a348ff61ca59a1b6217449f319">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_connections.py" startLineNumber="108" endLineNumber="111"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_connections.py" startLineNumber="102" endLineNumber="105"/>
            <text>
<![CDATA[            "key": "/works/OL1W",
            "type": {"key": "/type/work"},
            "authors": [],
        }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="6d59242b7df33ec79e5bea19a031d8d9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/db.py" startLineNumber="142" endLineNumber="146"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/db.py" startLineNumber="125" endLineNumber="131"/>
            <text>
<![CDATA[            )
        except (UniqueViolation, IntegrityError):
            # if any of the records would conflict with an exiting
            # record associated with new_username
            pass  # assuming impossible for now, not a great assumption

        t.rollback() if _test else t.commit()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="29717d0e18229a1a7ef2c22d840912b2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="861" endLineNumber="864"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="599" endLineNumber="602"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="411" endLineNumber="414"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="366" endLineNumber="369"/>
            <text>
<![CDATA[                "limit": limit,
                "offset": offset,
            }
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="8ae936651c6b11bccc558774b024e9a2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/home.py" startLineNumber="4" endLineNumber="8"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/design.py" startLineNumber="1" endLineNumber="5"/>
            <text>
<![CDATA[import web
import logging

from infogami.utils import delegate
from infogami.utils.view import render_template, public
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="5b5f9bddfac49338d8d219bf32c363e4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1094" endLineNumber="1098"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1046" endLineNumber="1050"/>
            <text>
<![CDATA[        'type': {'key': '/type/work'},
    }

    existing_edition = {
        'key': '/books/OL16M',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e11afb2d70eb121fdd636ffaf799c4aa">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="741" endLineNumber="744"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="694" endLineNumber="697"/>
            <text>
<![CDATA[    def GET(self, key):
        lst = cast(List | None, web.ctx.site.get(key))
        if not lst:
            raise web.notfound()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="2ee7aba06766dd1d7e8bbf606419ff5d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/edits.py" startLineNumber="296" endLineNumber="300"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/edits.py" startLineNumber="251" endLineNumber="255"/>
            <text>
<![CDATA[            updated=datetime.datetime.utcnow(),
            vars={"rid": rid},
        )

    @classmethod
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="addf22a89e6ef484cfe4ef92c6ac6dc3">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/publishers.py" startLineNumber="85" endLineNumber="90"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/languages.py" startLineNumber="104" endLineNumber="109"/>
            <text>
<![CDATA[    def normalize_key(self, key):
        return key

    def get_ebook_count(self, name, value, publish_year):
        # Query solr for this publish_year and publish_year combination and read the has_fulltext=true facet
        solr = search.get_solr()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="8e5d9c98ced42fdab17448da0570f62a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="69" endLineNumber="72"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/editions.py" startLineNumber="27" endLineNumber="30"/>
            <text>
<![CDATA[        "has_fulltext",
        "title_suggest",
        "publish_year",
        "language",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="a2c4ca93951fd5b71c6014e76879c3c9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="579" endLineNumber="582"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="357" endLineNumber="360"/>
            <text>
<![CDATA[    b'{Oacute}': b'\xe2O',
    b'{Ocirc}': b'\xe3O',
    b'{Ocy}': b'O',
    b'{Odblac}': b'\xeeO',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="fb9b0c28d6635ca301bf6db3751c1f27">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="359" endLineNumber="363"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="323" endLineNumber="327"/>
            <text>
<![CDATA[        }
    }

    create(record0)
    create(record1)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="12a6cd72ac0d03c5774246ecfae0a951">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/ol_infobase.py" startLineNumber="182" endLineNumber="185"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/ol_infobase.py" startLineNumber="153" endLineNumber="156"/>
            <text>
<![CDATA[            vars=locals(),
        )[0]
        .count
    )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="7473409dbfb496a9a999715a3158d6c8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_rdf.py" startLineNumber="80" endLineNumber="83"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_opds.py" startLineNumber="62" endLineNumber="65"/>
            <text>
<![CDATA[        if isinstance(e.tag, str) and e.tag in parser_map:
            key = parser_map[e.tag][0]
            (new_key, val) = parser_map[e.tag][1](e, key)
            if new_key:
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="dfc5394188df2c184644c0dfc0852df8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="203" endLineNumber="206"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="133" endLineNumber="136"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="24" endLineNumber="27"/>
            <text>
<![CDATA[            },
        },
    ),
    (
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="fb0bc8f4908207c5f5a78dd66ae033a4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/stats.py" startLineNumber="4" endLineNumber="7"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/data/dump.py" startLineNumber="13" endLineNumber="16"/>
            <text>
<![CDATA[import logging
import os
import re
import sys
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="ca9477ec015512e67bb3c6fb65eb3271">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/tests/test_code.py" startLineNumber="103" endLineNumber="106"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/tests/test_code.py" startLineNumber="74" endLineNumber="77"/>
            <text>
<![CDATA[    ia_metadata = {
        "creator": "The Author",
        "date": "2013",
        "identifier": "ia_frisian001",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="d8e8a3c351e88c895b283bc3b8d7d13b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="136" endLineNumber="139"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="100" endLineNumber="103"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="67" endLineNumber="70"/>
            <text>
<![CDATA[                "Read Count": "0",
                "Recommended By": "",
                "Recommended For": "",
                "Spoiler": "",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="6ebc7894a242d6dd5ec26365ef445322">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1455" endLineNumber="1458"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1449" endLineNumber="1452"/>
            <text>
<![CDATA[            True,
            False,
        ),
        (
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f57c231952dc7cbc1d12950ada8ede29">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1418" endLineNumber="1422"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1293" endLineNumber="1297"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1239" endLineNumber="1243"/>
            <text>
<![CDATA[    }

    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'modified'
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="d56228b81cc0248ebc8afe003ebc7f05">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="621" endLineNumber="624"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="464" endLineNumber="467"/>
            <text>
<![CDATA[                )
            )
            == 0
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="fce55c384a6576322eb6979c2af8752c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="103" endLineNumber="106"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="77" endLineNumber="80"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="63" endLineNumber="66"/>
            <text>
<![CDATA[        start = kargs['start'].strftime("%Y-%m-%d")
        end = kargs['end'].strftime("%Y-%m-%d %H:%M:%S")
        db = kargs['thingdb']
    except KeyError as k:
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="388c05b6a1ef935b54ca2b6ffd9ca6e9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="202" endLineNumber="206"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="191" endLineNumber="195"/>
            <text>
<![CDATA[        key = "ia-scan/" + identifier
        store_key = "/_store/" + key
        # If the entry is not found, create an entry
        try:
            jsontext = self.store_get(sitename, store_key)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="0b83920b99caa22461d97314e19001d3">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/home.py" startLineNumber="203" endLineNumber="206"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/home.py" startLineNumber="196" endLineNumber="199"/>
            <text>
<![CDATA[        query=query,
        subject=subject,
        sorts=sorts,
        limit=limit,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="cccb3ee555b6f178276c919916bb45bc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/mocks/tests/test_mock_infobase.py" startLineNumber="43" endLineNumber="46"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/mocks/tests/test_mock_infobase.py" startLineNumber="22" endLineNumber="25"/>
            <text>
<![CDATA[        doc = {
            "key": "/books/OL1M",
            "type": {"key": "/type/edition"},
            "title": "The Test Book",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="2f41c7526030ddbbc5efd9add42013b6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/edits.py" startLineNumber="245" endLineNumber="248"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/edits.py" startLineNumber="224" endLineNumber="228"/>
            <text>
<![CDATA[            oldb = db.get_db()

            oldb.update(
                cls.TABLENAME,
                where="id=$rid",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="a340ba41c64ae3c8b28403467a1e9f48">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1392" endLineNumber="1396"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1148" endLineNumber="1152"/>
            <text>
<![CDATA[        'type': {'key': '/type/work'},
    }

    existing_edition = {
        'key': '/books/OL1M',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="ff3fac30014bb92de19ed2985db18513">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="447" endLineNumber="450"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="439" endLineNumber="442"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="424" endLineNumber="427"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="407" endLineNumber="410"/>
            <text>
<![CDATA[            "key": "/works/OL123W",
            "type": "work",
            "language": ["eng"],
            "title": "The Celebrated Jumping Frog of Calaveras County",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="cdc60d7ab512d8bc1cf51f0070ef06ab">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="556" endLineNumber="559"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="394" endLineNumber="397"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="157" endLineNumber="160"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="122" endLineNumber="125"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="101" endLineNumber="104"/>
            <text>
<![CDATA[            authors=[],
            data_provider=FakeDataProvider(),
            ia_metadata={},
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="81489d8a5594f399fd16942c222749b6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/code.py" startLineNumber="395" endLineNumber="398"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/code.py" startLineNumber="371" endLineNumber="374"/>
            <text>
<![CDATA[        if size:
            prefix = "%s_covers" % size
        else:
            prefix = "covers"
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="a0181a07ef64bf4d7283e3f6a07a5e50">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/imports.py" startLineNumber="160" endLineNumber="163"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/imports.py" startLineNumber="138" endLineNumber="141"/>
            <text>
<![CDATA[        """
        ia_ids = [
            f"{source}:{identifier}" for identifier in identifiers for source in sources
        ]
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="67a90e9041eb48e404fcfabe0d4bd635">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/opds.py" startLineNumber="276" endLineNumber="279"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/opds.py" startLineNumber="270" endLineNumber="273"/>
            <text>
<![CDATA[            {self.xsi + 'type': 'dcterms:URI'},
        )
        self.add_list(
            self.dcterms + 'identifier',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f40ba085083212122fdbb7bf3e1f60c3">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/statsdb.py" startLineNumber="5" endLineNumber="8"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/schema.py" startLineNumber="45" endLineNumber="48"/>
            <text>
<![CDATA[    CREATE TABLE stats (
        id serial primary key,
        key text unique,
        type text,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="bd750f9683316a53d93c611be47f3ba6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="571" endLineNumber="574"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="519" endLineNumber="522"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="295" endLineNumber="298"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="217" endLineNumber="220"/>
            <text>
<![CDATA[            ],
            authors=[],
            data_provider=FakeDataProvider(),
            ia_metadata={
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="19cf3eeb302355a9b7951cc254eafabe">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="635" endLineNumber="638"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="611" endLineNumber="614"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="587" endLineNumber="590"/>
            <text>
<![CDATA[            except:
                raise web.notfound('')
            else:
                return delegate.RawText(
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="d50f8117278975ff09391dbdd5be3787">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="129" endLineNumber="132"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="112" endLineNumber="115"/>
            <text>
<![CDATA[    )
    result = db.query(q1)
    count = result[0].count
    return count
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f656b7861f71010f6dee430c0bf59ea2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1052" endLineNumber="1055"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="999" endLineNumber="1002"/>
            <text>
<![CDATA[        'publishers': ['Black Spot'],
        'type': {'key': '/type/edition'},
        'source_records': ['non-marc:test'],
    }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="a4e5d42d055d90aa22e20537a18ed015">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="377" endLineNumber="381"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="341" endLineNumber="345"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="305" endLineNumber="309"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="268" endLineNumber="272"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="231" endLineNumber="235"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="194" endLineNumber="198"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="96" endLineNumber="100"/>
            <text>
<![CDATA[            }
        )

        s = addbook.SaveBookHelper(work, edition)
        s.save(formdata)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e106970f8e175a18aff6c8f6b57fa5dc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="172" endLineNumber="175"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="158" endLineNumber="161"/>
            <text>
<![CDATA[            "key": "/books/OL2M",
            "authors": [{"key": "/authors/OL2A"}],
            "title": "book 1",
        }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="d56a8201bb8e6074114643eafb68e253">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="70" endLineNumber="73"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="22" endLineNumber="25"/>
            <text>
<![CDATA[                    }
                }
            ),
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="5b27b8e22f7ebc2b99c3de13e7cedc62">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/ol_infobase.py" startLineNumber="476" endLineNumber="481"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/data/dump.py" startLineNumber="277" endLineNumber="282"/>
            <text>
<![CDATA[        if key.startswith(old):
            return new + key[len(old) :]
    return key


def _process_data(data):
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f55b4b36599a942143da788f87d6339f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/swagger.py" startLineNumber="1" endLineNumber="6"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/authors.py" startLineNumber="1" endLineNumber="6"/>
            <text>
<![CDATA[from infogami.utils import delegate
from infogami.utils.view import render_template


def setup():
    pass
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="965b2ea2fb225c258a431220e032293e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/checkins.py" startLineNumber="214" endLineNumber="218"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/checkins.py" startLineNumber="178" endLineNumber="182"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/checkins.py" startLineNumber="87" endLineNumber="91"/>
            <text>
<![CDATA[        user = get_current_user()
        if not user:
            raise web.unauthorized(message='Requires login')

        username = user['key'].split('/')[-1]
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="8749eb46059cd36899a634b49e661032">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1490" endLineNumber="1494"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1386" endLineNumber="1390"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1260" endLineNumber="1264"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1141" endLineNumber="1145"/>
            <text>
<![CDATA[    }

    existing_work = {
        'authors': [{'author': '/authors/OL1A', 'type': {'key': '/type/author_role'}}],
        'key': '/works/OL1W',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="2527ad1f9aea22721b0d1ec7d70f1a14">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1007" endLineNumber="1010"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="997" endLineNumber="1000"/>
            <text>
<![CDATA[        'title': 'Finding Existing',
        'subtitle': 'sub',
        'publishers': ['Black Spot'],
        'type': {'key': '/type/edition'},
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f7d955442e4100ec5dad68fa69e21d56">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/civicrm.py" startLineNumber="87" endLineNumber="90"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/civicrm.py" startLineNumber="36" endLineNumber="39"/>
            <text>
<![CDATA[            headers={
                'Authorization': f"Basic {lending.config_ia_civicrm_api.get('auth', '')}"
            },
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="c3e08caf5ccd5020017c444c7ab5562c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="106" endLineNumber="109"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="79" endLineNumber="82"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="61" endLineNumber="64"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="44" endLineNumber="47"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="32" endLineNumber="35"/>
            <text>
<![CDATA[        data = {
            'username': username,
            'year': year,
        }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="3d7b7fbeda8aa8dabffc636c9a508bc8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="367" endLineNumber="371"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="342" endLineNumber="345"/>
            <text>
<![CDATA[            data = f'{callback}({json.dumps(d)})'
        else:
            data = json.dumps(d)
        raise web.HTTPError('200 OK', {}, data)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="5939fb0701359b08f1afc4d239d44534">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="37" endLineNumber="40"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="30" endLineNumber="33"/>
            <text>
<![CDATA[        )
        assert len(req.deletes) == 0
        assert len(req.adds) == 1
        assert req.adds[0]['title'] == "__None__"
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="333468334486dec2d3a36dac080f4caf">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/sponsorships.py" startLineNumber="1" endLineNumber="4"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/fulltext.py" startLineNumber="1" endLineNumber="5"/>
            <text>
<![CDATA[import json
import logging

import requests
import web
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="9fbda981f0f561f6391c654e1df5d390">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/imports.py" startLineNumber="319" endLineNumber="322"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/imports.py" startLineNumber="307" endLineNumber="310"/>
            <text>
<![CDATA[            )
        except UndefinedTable:
            logger.exception("Database table import_item may not exist on localhost")
            return 0
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="9e81deac271b54ef8e1c174d729354a3">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="511" endLineNumber="514"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="17" endLineNumber="20"/>
            <text>
<![CDATA[    'observations': [
        {
            'id': 1,
            'label': 'Pace',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="df5c40c397b326e6ab4803583adf2fc8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="814" endLineNumber="817"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="71" endLineNumber="74"/>
            <text>
<![CDATA[            if since:
                query += " AND created >= $since"
        elif since:
            query += " WHERE created >= $since"
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="81389b4dd83909bb65409c9837377623">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="361" endLineNumber="364"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="227" endLineNumber="230"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="86" endLineNumber="89"/>
            <text>
<![CDATA[    @classmethod
    def setup_class(cls):
        web.config.db_parameters = {"dbn": "sqlite", "db": ":memory:"}
        db = get_db()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="25014851101e31e3afb23f3dd940b250">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/code.py" startLineNumber="5" endLineNumber="10"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/ia.py" startLineNumber="4" endLineNumber="7"/>
            <text>
<![CDATA[import logging
import os
import requests
import web
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="c703aee3a7e9ef1f9b438c68d868fabe">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="227" endLineNumber="230"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="206" endLineNumber="209"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="189" endLineNumber="192"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="645" endLineNumber="648"/>
            <text>
<![CDATA[                }
            ),
            content_type="application/json",
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="723236f109d997e54f2808683389613c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="827" endLineNumber="830"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="804" endLineNumber="807"/>
            <text>
<![CDATA[        """
        oldb = db.get_db()
        data = {
            'work_id': work_id,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="d4232014245e877866106a79e993b1bd">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/i18n/__init__.py" startLineNumber="285" endLineNumber="288"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/i18n/__init__.py" startLineNumber="279" endLineNumber="282"/>
            <text>
<![CDATA[                shutil.copy(pot_src, po_dest)
                os.chmod(po_dest, 0o666)
                print(f"File created at {po_dest}")
        else:
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="dcd5fd738b14cb72b8cf50627caaf18e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/models.py" startLineNumber="408" endLineNumber="411"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/merge_authors.py" startLineNumber="210" endLineNumber="213"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/dynlinks.py" startLineNumber="240" endLineNumber="243"/>
            <text>
<![CDATA[            def row(r):
                if isinstance(r, str):
                    level = 0
                    label = ""
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="2d55102c44c431fb9a656bc515c6ca39">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/bulk_tag.py" startLineNumber="61" endLineNumber="64"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="558" endLineNumber="561"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="542" endLineNumber="545"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="242" endLineNumber="245"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="184" endLineNumber="187"/>
            <text>
<![CDATA[        def response(msg, status="success"):
            return delegate.RawText(
                json.dumps({status: msg}), content_type="application/json"
            )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="59eb28ace7439fcb1c2c92e20e40acf0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/adapter.py" startLineNumber="224" endLineNumber="227"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/adapter.py" startLineNumber="194" endLineNumber="197"/>
            <text>
<![CDATA[    def before_request(self):
        if 'query' in self.input:
            q = self.input.query
            q = json.loads(q)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f58cf39d48268e996cb02fcd8efcad90">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="390" endLineNumber="393"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="283" endLineNumber="286"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="266" endLineNumber="269"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="178" endLineNumber="181"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="138" endLineNumber="141"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="101" endLineNumber="104"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="86" endLineNumber="89"/>
            <text>
<![CDATA[            ],
            'deleted': True,
        },
        {
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f235fea6af82ef2b1f7f769d3613982f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1420" endLineNumber="1423"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="815" endLineNumber="818"/>
            <text>
<![CDATA[    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'modified'
    assert reply['work']['status'] == 'modified'
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="6f04b271f2d2cf6bb2ac1488fc35e9eb">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="753" endLineNumber="757"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="672" endLineNumber="676"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="332" endLineNumber="335"/>
            <text>
<![CDATA[        rec = read_edition(marc)
        rec['source_records'] = ['ia:' + ia]
        reply = load(rec)
        assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="ab7d1d6593ce15a2b1a8fcbb1b359713">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="525" endLineNumber="528"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="384" endLineNumber="387"/>
            <text>
<![CDATA[                )
            )
            == 1
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="b4286b9854a46c795c33191e3fd33468">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="1080" endLineNumber="1083"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="110" endLineNumber="114"/>
            <text>
<![CDATA[        """
        oldb = db.get_db()

        data = {
            'username': username,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="3c13f69cf2b60b564c97f9fc87b555e0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/processors.py" startLineNumber="32" endLineNumber="35"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/processors.py" startLineNumber="23" endLineNumber="26"/>
            <text>
<![CDATA[                    + '<pre class="profile">'
                    + web.websafe(result)
                    + '</pre>'
                )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="123c240c435f236054064e2d44184458">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/code.py" startLineNumber="199" endLineNumber="203"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/code.py" startLineNumber="152" endLineNumber="156"/>
            <text>
<![CDATA[            )
        except ValueError:
            error(ERROR_BAD_IMAGE)

        _cleanup()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="1786a23554a6693461921e6f5c2703dc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="197" endLineNumber="200"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="178" endLineNumber="181"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="152" endLineNumber="156"/>
            <text>
<![CDATA[            },
        )
        # 'West Indies, British -- Relations -- Great Britain.')
    ]
    for value, expect in data:
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f55d5a0e5be58e9108e5e239310fabe1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/solr/updater/work.py" startLineNumber="562" endLineNumber="566"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/solr/updater/edition.py" startLineNumber="133" endLineNumber="137"/>
            <text>
<![CDATA[            ),
            None,
        )

    @property
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="de56198faba7f599ba89d65266dbf7f5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="158" endLineNumber="162"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="124" endLineNumber="128"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="59" endLineNumber="63"/>
            <text>
<![CDATA[            }
        )

        s = addbook.SaveBookHelper(None, edition)
        s.save(formdata)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="1399b11acbbd0114f791ced4696c1a8c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="493" endLineNumber="496"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="479" endLineNumber="482"/>
            <text>
<![CDATA[        'oclc_numbers': ['/books/OL1M'],
        'title': ['/books/OL1M'],
        'ocaid': ['/books/OL1M'],
    }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="dd0ba04b433deb4b5c21c161661a28d6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/edits.py" startLineNumber="135" endLineNumber="138"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/edits.py" startLineNumber="130" endLineNumber="133"/>
            <text>
<![CDATA[                )
            else:
                resp = response(
                    status='error',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="c555cf851dbca2d6e4875dba16647934">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/accounts/model.py" startLineNumber="295" endLineNumber="298"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/accounts/model.py" startLineNumber="288" endLineNumber="291"/>
            <text>
<![CDATA[        if doc := web.ctx.site.store.get(key):
            return Link(doc)
        else:
            return False
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="6c28cb3433ea40caa13b53fc7c2192d0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/olbase/tests/test_events.py" startLineNumber="44" endLineNumber="47"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/olbase/tests/test_events.py" startLineNumber="17" endLineNumber="20"/>
            <text>
<![CDATA[            "docs": [
                {
                    "key": "/people/anand/lists/OL1L",
                    "type": {"key": "/type/list"},
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f79cf9d6a5df1bdb012a9fe49716e999">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/olbase/tests/test_events.py" startLineNumber="54" endLineNumber="58"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/olbase/tests/test_events.py" startLineNumber="23" endLineNumber="26"/>
            <text>
<![CDATA[                }
            ],
        }
        m = events.MemcacheInvalidater()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="58d38104b0ac6aa8e36138cfdb5ad0bc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="1062" endLineNumber="1065"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="887" endLineNumber="890"/>
            <text>
<![CDATA[        if edition.works:
            work = edition.works[0]
        else:
            work = None
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="95804947586b63ce8a556a7e2b27e615">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_unmarshal.py" startLineNumber="24" endLineNumber="28"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/api.py" startLineNumber="272" endLineNumber="276"/>
            <text>
<![CDATA[    """Parses ISO datetime formatted string.::

    >>> parse_datetime("2009-01-02T03:04:05.006789")
    datetime.datetime(2009, 1, 2, 3, 4, 5, 6789)
    """
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="11b681e07ec9e1413cb4c62885ad0db7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_lending.py" startLineNumber="37" endLineNumber="41"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_lending.py" startLineNumber="11" endLineNumber="15"/>
            <text>
<![CDATA[        monkeypatch.setattr(
            lending, "get_availability_of_ocaids", mock_get_availability_of_ocaids
        )

        f = lending.add_availability
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="7af63440f3f4d2bf9181b4cf61700ad5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/utils/__init__.py" startLineNumber="364" endLineNumber="367"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/__init__.py" startLineNumber="752" endLineNumber="755"/>
            <text>
<![CDATA[    required_fields = [
        'title',
        'source_records',
    ]  # ['authors', 'publishers', 'publish_date']
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="848ea8bada7c25b9eeee84f8609318bb">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="84" endLineNumber="87"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="30" endLineNumber="33"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="11" endLineNumber="14"/>
            <text>
<![CDATA[        with (
            patch('web.input') as mock_web_input,
            patch('web.data') as mock_web_data,
        ):
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="153c8c57712f599e34cd26b6d8c59777">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="404" endLineNumber="408"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="359" endLineNumber="363"/>
            <text>
<![CDATA[        if limit > 1000:
            limit = 1000

        keys = web.ctx.site.things(
            {
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="7e4e6b554d070f33a956303140bcb49e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="110" endLineNumber="113"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="90" endLineNumber="93"/>
            <text>
<![CDATA[        f"v.transaction_id=t.id AND t.created >= '{start}' and t.created < '{end}' AND "
        "t.author_id IN (SELECT thing_id FROM account WHERE bot = 't')"
    )
    result = db.query(q1)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="5753230e4e543b91dffce7ad9934b733">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="420" endLineNumber="423"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="371" endLineNumber="374"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="357" endLineNumber="360"/>
            <text>
<![CDATA[        rec = read_edition(MarcBinary(data))
        rec['source_records'] = ['ia:' + ia]
        reply = load(rec)
        assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e21123337479cbf93384cd0d1fcf8342">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="461" endLineNumber="464"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/ol_infobase.py" startLineNumber="475" endLineNumber="478"/>
            <text>
<![CDATA[    for old, new in web.group(mapping, 2):
        if key.startswith(old):
            return new + key[len(old) :]
    return key
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="3c3720f909f4fc759af0b42175169fb8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="260" endLineNumber="263"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="242" endLineNumber="245"/>
            <text>
<![CDATA[        )
        assert d.has_fulltext is True
        assert d.public_scan_b is False
        assert d.printdisabled_s == 'OL1M'
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f2729e6dd5b278f9b78971afd0cc87e7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="112" endLineNumber="115"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="85" endLineNumber="88"/>
            <text>
<![CDATA[            "key": "/books/OL9M",
            "title": "foo",
            "subtitle": "bar",
            "by_statement": "Mark Twain",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="2d43b67774c7c576cbad7dc8024f458a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_lcc.py" startLineNumber="116" endLineNumber="121"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_ddc.py" startLineNumber="123" endLineNumber="128"/>
            <text>
<![CDATA[]


@pytest.mark.parametrize(
    "prefix,normed,name", PREFIX_TESTS, ids=[t[-1] for t in PREFIX_TESTS]
)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e05f3ff504260a26a818d454fcddef2c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="1102" endLineNumber="1106"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="752" endLineNumber="756"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/lists/model.py" startLineNumber="86" endLineNumber="90"/>
            <text>
<![CDATA[    def url(self, suffix="", **params):
        return self.get_url(suffix, **params)

    def get_url_suffix(self):
        return self.name or "unnamed"
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="df7e3b1e3d1e3d2404b094c07ea9e389">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_utils.py" startLineNumber="65" endLineNumber="69"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_utils.py" startLineNumber="41" endLineNumber="45"/>
            <text>
<![CDATA[    class TestContext:
        def __init__(self):
            self.share_links = None

    test_context = TestContext()
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="3df10abae6e0b355caa9c768a8f57d44">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/accounts/model.py" startLineNumber="601" endLineNumber="604"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/accounts/model.py" startLineNumber="234" endLineNumber="237"/>
            <text>
<![CDATA[        except ClientException as e:
            code = e.get_data().get("code")
            return code
        else:
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="a2c0209eaf6ed7d59bcff65303c4330b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/ratings.py" startLineNumber="217" endLineNumber="220"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="546" endLineNumber="549"/>
            <text>
<![CDATA[                edition_id=edition_id,
            )
        else:
            where = "work_id=$work_id AND username=$username"
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="180daf2088b02bd282c5fb6f552c141d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="521" endLineNumber="524"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="325" endLineNumber="328"/>
            <text>
<![CDATA[    b'{Iacute}': b'\xe2I',
    b'{Icaron}': b'\xe9I',
    b'{Icirc}': b'\xe3I',
    b'{Icy}': b'I',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="6280210fc0d5ac03bdfc3e4e3e80cec1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/catalog/test_utils.py" startLineNumber="273" endLineNumber="276"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1469" endLineNumber="1472"/>
            <text>
<![CDATA[            False,
        ),
    ],
)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="9ac29f0c6158eb14fb40cc0a93d9f284">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="1081" endLineNumber="1084"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="70" endLineNumber="74"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="50" endLineNumber="54"/>
            <text>
<![CDATA[        oldb = db.get_db()

        data = {
            'username': username,
            'work_id': work_id,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="3c291c61ea6ddfcd6a5801a6857855a7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/ia.py" startLineNumber="256" endLineNumber="260"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/ia.py" startLineNumber="237" endLineNumber="241"/>
            <text>
<![CDATA[        metadata = self.metadata

        key2 = key2 or key
        if key in metadata and metadata[key]:
            value = metadata[key]
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="3336beabf968d76cb3242a2f061f2b81">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_ddc.py" startLineNumber="5" endLineNumber="8"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="23" endLineNumber="26"/>
            <text>
<![CDATA[    normalize_ddc,
    normalize_ddc_prefix,
    normalize_ddc_range,
)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="6beba1e80498ca83785fb1d398d755bd">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="70" endLineNumber="73"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="43" endLineNumber="46"/>
            <text>
<![CDATA[                name='foo data',
                description='bar',
                seeds=[{'key': '/books/OL1M'}, {'key': '/books/OL2M'}],
            )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="1fd4d6546adaf870d600090599c2dd50">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="1082" endLineNumber="1085"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="1035" endLineNumber="1038"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="72" endLineNumber="75"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/booknotes.py" startLineNumber="115" endLineNumber="118"/>
            <text>
<![CDATA[        data = {
            'username': username,
            'work_id': work_id,
            'edition_id': edition_id,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="ec09acc874ef47b63410e3f81ca36e16">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="236" endLineNumber="240"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="125" endLineNumber="128"/>
            <text>
<![CDATA[    def POST(self):
        web.header('Content-Type', 'application/json')
        if not can_write():
            raise web.HTTPError('403 Forbidden')
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e6efe3837505c8d6089a4ce4d402b55b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="709" endLineNumber="713"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="693" endLineNumber="697"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="539" endLineNumber="543"/>
            <text>
<![CDATA[        }
    )

    mock_site.save(
        {
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f339312022bb5d156b3c7aac0e802517">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/db.py" startLineNumber="130" endLineNumber="134"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/db.py" startLineNumber="115" endLineNumber="118"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/db.py" startLineNumber="41" endLineNumber="46"/>
            <text>
<![CDATA[    now = datetime.datetime.utcnow()

    db = getdb()

    t = db.transaction()
    try:
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="a848c8397166d1735e8f8208dd271f3a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="554" endLineNumber="558"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/booknotes.py" startLineNumber="186" endLineNumber="190"/>
            <text>
<![CDATA[            edition_id=edition_id,
            vars=data,
        )

    @classmethod
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="63c4caa5f290512728dffa0a647ffc0c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="612" endLineNumber="615"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="534" endLineNumber="537"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="396" endLineNumber="399"/>
            <text>
<![CDATA[                )
            )
            == 2
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e8e782032a8f15a68852430859435bf3">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/admin/code.py" startLineNumber="40" endLineNumber="43"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/app.py" startLineNumber="65" endLineNumber="68"/>
            <text>
<![CDATA[def render_template(name, *a, **kw):
    if "." in name:
        name = name.rsplit(".", 1)[0]
    return render[name](*a, **kw)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="493c3ff616afdd36811ba01c6e102e8a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/merge_authors.py" startLineNumber="286" endLineNumber="289"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/merge_authors.py" startLineNumber="269" endLineNumber="272"/>
            <text>
<![CDATA[        user = get_current_user()
        can_merge = user and (
            user.is_admin() or user.is_usergroup_member('/usergroup/super-librarians')
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="76c2aaf9eb51293e42476ce10eb26836">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1363" endLineNumber="1366"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1349" endLineNumber="1352"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1326" endLineNumber="1329"/>
            <text>
<![CDATA[            },
            None,
        ),
        (
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="407cad68e1c7c5a000cb6aaeca83e3fd">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_doctests.py" startLineNumber="14" endLineNumber="17"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/tests/test_doctests.py" startLineNumber="20" endLineNumber="23"/>
            <text>
<![CDATA[        runner = doctest.DocTestRunner(verbose=True)
        failures, tries = runner.run(test)
        if failures:
            pytest.fail("doctest failed: " + test.name)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="5699e6a03b636b9c647f9e113e0d0b3b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="219" endLineNumber="222"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="197" endLineNumber="200"/>
            <text>
<![CDATA[                    return delegate.RawText(
                        json.dumps(
                            {
                                'username': ol_account.username,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="2715dd2f149b2da66922b9961a3d3b73">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_vendors.py" startLineNumber="174" endLineNumber="177"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_vendors.py" startLineNumber="80" endLineNumber="83"/>
            <text>
<![CDATA[        "product_group": "Book",
        "qlt": "used",
    }
    result = clean_amazon_metadata_for_load(amazon)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="049eb52c52a526479ca8a79d119d2b02">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/code.py" startLineNumber="789" endLineNumber="792"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/code.py" startLineNumber="427" endLineNumber="430"/>
            <text>
<![CDATA[            subject_facet=[],
            person_facet=[],
            place_facet=[],
            time_facet=[],
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="2fb951f462da91fce47c7aca154d3ee6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="758" endLineNumber="761"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="739" endLineNumber="742"/>
            <text>
<![CDATA[        add_flash_message(
            'note', _("Notification preferences have been updated successfully.")
        )
        web.seeother("/account")
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="75f632d7d46319b4fb9af7b0d395619e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_query_utils.py" startLineNumber="28" endLineNumber="31"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="376" endLineNumber="380"/>
            <text>
<![CDATA[                            try:
                                luqum_remove_child(node, parents)
                            except EmptyTreeError:
                                # Deleted the whole tree! Nothing left
                                return ''
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="9c682662495465c97ce057cfc00cca5f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/subjects.py" startLineNumber="160" endLineNumber="163"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/subjects.py" startLineNumber="150" endLineNumber="153"/>
            <text>
<![CDATA[        {
            "key": "/subjects/Love",
            "name": "Love",
            "work_count": 5129,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="fdd838477af78fd87e075232ed28ded2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_lcc.py" startLineNumber="133" endLineNumber="138"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_ddc.py" startLineNumber="137" endLineNumber="142"/>
            <text>
<![CDATA[]


@pytest.mark.parametrize(
    "raw,normed,name", RANGE_TESTS, ids=[t[-1] for t in RANGE_TESTS]
)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="31019c181a68417298f97b1e13babb48">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/publishers.py" startLineNumber="38" endLineNumber="42"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/languages.py" startLineNumber="34" endLineNumber="38"/>
            <text>
<![CDATA[    def normalize_key(self, key):
        return key

    def process_key(self, key):
        return key.replace("_", " ")
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f8cda5efddae1ad9337448d5dfdbba7a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/catalog/test_utils.py" startLineNumber="325" endLineNumber="328"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/catalog/test_utils.py" startLineNumber="242" endLineNumber="245"/>
            <text>
<![CDATA[@pytest.mark.parametrize(
    'name, rec, expected',
    [
        (
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="800fcfa8cbcfce0ffed2b6ae219c9275">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1292" endLineNumber="1296"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1180" endLineNumber="1184"/>
            <text>
<![CDATA[        'title': 'Some Title',
    }

    reply = load(rec)
    assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="df5b55581566bc6e31070178e08bdfa4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/readlinks.py" startLineNumber="170" endLineNumber="173"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/dynlinks.py" startLineNumber="344" endLineNumber="347"/>
            <text>
<![CDATA[                "small": "https://covers.openlibrary.org/b/id/%s-S.jpg" % cover_id,
                "medium": "https://covers.openlibrary.org/b/id/%s-M.jpg" % cover_id,
                "large": "https://covers.openlibrary.org/b/id/%s-L.jpg" % cover_id,
            }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e29249cb52232590ef4b723973ec1481">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="555" endLineNumber="558"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="171" endLineNumber="174"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="156" endLineNumber="159"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="100" endLineNumber="103"/>
            <text>
<![CDATA[            ],
            authors=[],
            data_provider=FakeDataProvider(),
            ia_metadata={},
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="0323eb008b90070ca7a16229dcec84ac">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/tests/test_webapp.py" startLineNumber="31" endLineNumber="34"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/tests/test_coverstore.py" startLineNumber="16" endLineNumber="19"/>
            <text>
<![CDATA[@pytest.fixture()
def image_dir(tmpdir):
    tmpdir.mkdir('localdisk')
    tmpdir.mkdir('items')
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="60acc53b521fe1db078b5f6ada6be706">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="983" endLineNumber="987"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/booknotes.py" startLineNumber="151" endLineNumber="155"/>
            <text>
<![CDATA[            GROUP BY work_id
            LIMIT $limit OFFSET $offset
        """

        return list(oldb.query(query, vars=data))
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f956720b8a54a4e460c31ce3ab1ea856">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="209" endLineNumber="212"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="197" endLineNumber="200"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="185" endLineNumber="188"/>
            <text>
<![CDATA[                }
            ],
            "title": "book 1",
        }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="a74bef2d065dfbd823ad180c6c93306b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="160" endLineNumber="163"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="135" endLineNumber="138"/>
            <text>
<![CDATA[        'authors': [{'name': 'Test author'}],
    }
    things = doc_to_things(doc)
    expected = [
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="0070389ce7fb9ed34ff5d6072efc97b8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="150" endLineNumber="153"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="34" endLineNumber="37"/>
            <text>
<![CDATA[            }
        },
    ),
    (
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e2ac7cb0a98e7745f284e44c6e4a622b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="147" endLineNumber="150"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="84" endLineNumber="87"/>
            <text>
<![CDATA[                },
            ]
        )
        edition = web.ctx.site.get("/books/OL1M")
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="bea2094d669d8c02991007971b67c7b5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/subjects.py" startLineNumber="271" endLineNumber="274"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="100" endLineNumber="103"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/code.py" startLineNumber="533" endLineNumber="536"/>
            <text>
<![CDATA[                "subject_facet",
                "person_facet",
                "place_facet",
                "time_facet",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e21da90a34e30edbec775cd851f3009d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/sendmail.py" startLineNumber="20" endLineNumber="24"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/accounts/model.py" startLineNumber="57" endLineNumber="61"/>
            <text>
<![CDATA[        )

        print("sending email", message, file=web.debug)
    else:
        web.sendmail(
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="43b586bc5aaea748dfae04ed442f4b54">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1181" endLineNumber="1185"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1120" endLineNumber="1124"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="321" endLineNumber="324"/>
            <text>
<![CDATA[    }
    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'matched'
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="71bd85820b401f883710cac113dedc74">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="140" endLineNumber="144"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="128" endLineNumber="132"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="116" endLineNumber="120"/>
            <text>
<![CDATA[            },
        ),
        # 'United States -- History -- Revolution, 1775-1783 -- Influence.'
        (
            [
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="fef6af6f04a14ce454887fdc1d8cec87">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="389" endLineNumber="392"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/ol_infobase.py" startLineNumber="292" endLineNumber="295"/>
            <text>
<![CDATA[    dir = os.path.dirname(path)
    if not os.path.exists(dir):
        os.makedirs(dir)
    f = open(path, 'w')
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="f4bb84fe14c0f8defd49339444d524ec">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="131" endLineNumber="134"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="95" endLineNumber="98"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="62" endLineNumber="65"/>
            <text>
<![CDATA[                "Original Purchase Date": "",
                "Original Purchase Location": "",
                "Owned Copies": "0",
                "Private Notes": "",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="91951bfdc95d6217e8e8e8f21eaf9558">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/models.py" startLineNumber="415" endLineNumber="418"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/merge_authors.py" startLineNumber="222" endLineNumber="225"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/ol_infobase.py" startLineNumber="515" endLineNumber="518"/>
            <text>
<![CDATA[            level = safeint(r.get('level', '0'), 0)
            label = r.get('label', '')
            title = r.get('title', '')
            pagenum = r.get('pagenum', '')
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="ae9c80d10924ee0ced76fe3e4c717bc9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/bulkimport.py" startLineNumber="325" endLineNumber="328"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/bulkimport.py" startLineNumber="262" endLineNumber="265"/>
            <text>
<![CDATA[            "created",
            "last_modified",
            "permission",
            "child_permission",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="eceffff9192e490885a9dba2b490c077">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_checkins.py" startLineNumber="70" endLineNumber="73"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_checkins.py" startLineNumber="57" endLineNumber="60"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_checkins.py" startLineNumber="51" endLineNumber="54"/>
            <text>
<![CDATA[            'year': 2000,
            'month': 3,
            'day': 7,
        }
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="434dcd347a8b224cc037b74940459e07">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_isbn.py" startLineNumber="2" endLineNumber="5"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/vendors.py" startLineNumber="24" endLineNumber="27"/>
            <text>
<![CDATA[from openlibrary.utils.isbn import (
    isbn_10_to_isbn_13,
    isbn_13_to_isbn_10,
    normalize_isbn,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="ba5536d2f00417db852e677633bf8e1d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="204" endLineNumber="207"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="192" endLineNumber="195"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="180" endLineNumber="183"/>
            <text>
<![CDATA[            "key": "/works/OL2W",
            "authors": [
                {
                    "type": {"key": "/type/author_role"},
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="cdcda245f2f11d1997c3e3acd0de5ac5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1265" endLineNumber="1269"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1147" endLineNumber="1151"/>
            <text>
<![CDATA[        'title': 'Some Title',
        'type': {'key': '/type/work'},
    }

    existing_edition = {
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="dd291dfc8686c4442331a61d96e6365d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_rdf.py" startLineNumber="3" endLineNumber="9"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_opds.py" startLineNumber="3" endLineNumber="9"/>
            <text>
<![CDATA["""

from openlibrary.plugins.importapi import import_edition_builder


def parse_string(e, key):
    return (key, e.text)
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="e23d6ccef1078b8cd7a4578399e3d313">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="353" endLineNumber="356"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="345" endLineNumber="348"/>
            <text>
<![CDATA[            "username": "@eliot_rosewater",
            "work_id": 3,
            "edition_id": 4,
            "event_type": 3,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="3b264b634834861fc3e3add93a2e0674">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="54" endLineNumber="57"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="33" endLineNumber="36"/>
            <text>
<![CDATA[    {
        'id': 1,
        'batch_id': 1,
        'ia_id': 'unique_id_1',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="5bb0341159b16b57e80bcc7ebc641f88">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="264" endLineNumber="267"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="247" endLineNumber="250"/>
            <text>
<![CDATA[        return {
            "comment": "",
            "author": None,
            "ip": "127.0.0.1",
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="ce5d5d36e42333b5c6988b1503f91fdc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="503" endLineNumber="506"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="494" endLineNumber="497"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="484" endLineNumber="487"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="476" endLineNumber="479"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="466" endLineNumber="469"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="452" endLineNumber="455"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="436" endLineNumber="439"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="143" endLineNumber="146"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="134" endLineNumber="137"/>
            <text>
<![CDATA[            [],
            FakeDataProvider(),
            {},
        )
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="0421a8fac7933f1dae79475746d08762">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="358" endLineNumber="361"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="333" endLineNumber="336"/>
            <text>
<![CDATA[        rec['source_records'] = ['ia:' + ia]
        reply = load(rec)
        assert reply['success'] is True
        assert reply['edition']['status'] == 'created'
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="6f9371334627fe9415b6fcebb7d03a67">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="629" endLineNumber="633"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="581" endLineNumber="585"/>
            <text>
<![CDATA[            raise web.notfound('')
        else:
            from infogami.utils import template

            try:
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="751b387aa51a372b69f6ae85d1b0f985">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_ddc.py" startLineNumber="41" endLineNumber="44"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_ddc.py" startLineNumber="36" endLineNumber="39"/>
            <text>
<![CDATA[        ['015.73 s'],
        "Parentheses indicating Dewey numbers assigned to a series.",
    ),
    (
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="8c482e9135d66ae5fe2379aaae19422e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1495" endLineNumber="1499"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1212" endLineNumber="1216"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1093" endLineNumber="1097"/>
            <text>
<![CDATA[        'title': 'Finding Existing Works',
        'type': {'key': '/type/work'},
    }

    existing_edition = {
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="b0624488631677bac9123bc1df0c8406">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="348" endLineNumber="352"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="310" endLineNumber="314"/>
            <text>
<![CDATA[        }
    }

    record1 = {
        'doc': {
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="20cb11faf2a3343ba74c422985325d43">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/edits.py" startLineNumber="152" endLineNumber="156"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/db.py" startLineNumber="117" endLineNumber="121"/>
            <text>
<![CDATA[        t = oldb.transaction()

        try:
            rows_changed = oldb.update(
                cls.TABLENAME,
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="23e2372819d8a94a0b8c26f22728e8dd">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="315" endLineNumber="319"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="302" endLineNumber="305"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="137" endLineNumber="140"/>
            <text>
<![CDATA[    rec = {
        'ocaid': 'test_item',
        'source_records': ['ia:test_item'],
        'title': 'Test item',
]]>
            </text>
        </set>
        <set lineCount="4" fingerprint="07d98cb6b10aa869761d55250461f8ad">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_unmarshal.py" startLineNumber="68" endLineNumber="71"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1613" endLineNumber="1616"/>
            <text>
<![CDATA[                },
            ),
        ],
    )
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="55f34009e0f923e50a48665a140dec96">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_connections.py" startLineNumber="45" endLineNumber="50"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_connections.py" startLineNumber="60" endLineNumber="65"/>
            <text>
<![CDATA[            "type": {"key": "/type/edition"},
            "title": "The Book",
        }

        add(
            {
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="86c8089eb2f259606e26d868d35200a6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="199" endLineNumber="204"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="224" endLineNumber="228"/>
            <text>
<![CDATA[        )
        assert d.has_fulltext is True
        assert d.public_scan_b is False
        assert d.printdisabled_s is None
        assert d.lending_edition_s == 'OL1M'
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="de22741dae26d495cbc0fc8d008cb645">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_unmarshal.py" startLineNumber="59" endLineNumber="63"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_unmarshal.py" startLineNumber="64" endLineNumber="68"/>
            <text>
<![CDATA[            {
                "key1": "value1",
                "key2": {"value2": "value2", "type": "/type/text"},
                "key3": "2009-01-02T03:04:05.006789",
            },
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="619818fb9109e9e97049fdd495d11578">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/tests/test_code_ils.py" startLineNumber="29" endLineNumber="33"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/tests/test_code_ils.py" startLineNumber="42" endLineNumber="46"/>
            <text>
<![CDATA[        mock_site.save(doc, timestamp=timestamp)
        assert format_result({'doc': doc}, False, "") == {
            'status': 'found',
            'olid': 'OL1M',
            'key': '/books/OL1M',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="8fd01f3cd1dc26c66500b21eae672dea">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="494" endLineNumber="498"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="503" endLineNumber="507"/>
            <text>
<![CDATA[            [],
            FakeDataProvider(),
            {},
        )
        assert wsb.number_of_pages_median == 122
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="8a926ebcc93df256f9addc7defec0651">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/views/showmarc.py" startLineNumber="25" endLineNumber="29"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/views/showmarc.py" startLineNumber="37" endLineNumber="41"/>
            <text>
<![CDATA[            try:
                response = requests.get(url)
                response.raise_for_status()
                data = response.content
            except requests.HTTPError as e:
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="e931b770fff8ec71a258794213b2e82e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="287" endLineNumber="291"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="314" endLineNumber="318"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="334" endLineNumber="338"/>
            <text>
<![CDATA[        "isbn:1234567890": {
            "bib_key": "isbn:1234567890",
            "info_url": "https://openlibrary.org/books/OL1M/foo",
            "preview": "noview",
            "preview_url": "https://openlibrary.org/books/OL1M/foo",
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="caded23385061b4293227d72df15f215">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/__init__.py" startLineNumber="154" endLineNumber="158"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/ol_infobase.py" startLineNumber="595" endLineNumber="599"/>
            <text>
<![CDATA[        norm = norm.replace(' and ', ' ')
        if norm.startswith('the '):
            norm = norm[4:]
        elif norm.startswith('a '):
            norm = norm[2:]
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="305cf20ae12d4dfd84671a01aefe3413">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1160" endLineNumber="1166"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1279" endLineNumber="1285"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1404" endLineNumber="1410"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1055" endLineNumber="1061"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1107" endLineNumber="1113"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1225" endLineNumber="1231"/>
            <text>
<![CDATA[    }

    mock_site.save(author)
    mock_site.save(existing_work)
    mock_site.save(existing_edition)

    rec = {
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="073d1f9ad12b7dc8ac817830d8d0a173">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="38" endLineNumber="42"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="59" endLineNumber="63"/>
            <text>
<![CDATA[    },
    {
        'id': 2,
        'batch_id': 1,
        'ia_id': 'unique_id_2',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="d04233cf1f46c01f2b41828304305ec4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="185" endLineNumber="189"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="199" endLineNumber="203"/>
            <text>
<![CDATA[        'source_records': 'ia:test_item',
    }
    reply = load(rec)
    assert reply['success'] is True
    w = mock_site.get(reply['work']['key'])
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="a8cd10cb0ab4349f0a093c08ad2da961">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/data/sitemap.py" startLineNumber="8" endLineNumber="13"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/data/sitemap.py" startLineNumber="7" endLineNumber="12"/>
            <text>
<![CDATA[http://www.archive.org/download/ol-sitemaps/sitemap-books-0001.xml.gz
http://www.archive.org/download/ol-sitemaps/sitemap-books-0001.xml.gz

http://www.archive.org/download/ol-sitemaps/sitindex-books.xml.gz
http://www.archive.org/download/ol-sitemaps/sitindex-authors.xml.gz
http://www.archive.org/download/ol-sitemaps/sitindex-works.xml.gz
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="02950d0243155622d387784aa33e4165">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="116" endLineNumber="121"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="140" endLineNumber="145"/>
            <text>
<![CDATA[            },
        ),
        # 'Great Britain -- Relations -- West Indies, British.'),
        (
            [
                ('a', 'West Indies, British'),
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="0d1d122c44d7ac12c3f6edeefe02e883">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="100" endLineNumber="104"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="156" endLineNumber="160"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="555" endLineNumber="559"/>
            <text>
<![CDATA[            ],
            authors=[],
            data_provider=FakeDataProvider(),
            ia_metadata={},
        )
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="4e9bf340d46fd7a089be453b4c0dfd3f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="129" endLineNumber="136"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/utils.py" startLineNumber="372" endLineNumber="380"/>
            <text>
<![CDATA[    for v in versions:
        v.created = v.created.isoformat()
        v.author = v.author and v.author.key

        # XXX-Anand: hack to avoid too big data to be stored in memcache.
        # v.changes is not used and it contributes to memcache bloat in a big way.
        v.changes = '[]'

    return versions
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="59f6547c74089cf4e009f9156d517f6a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="231" endLineNumber="237"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="341" endLineNumber="347"/>
            <text>
<![CDATA[            }
        )

        s = addbook.SaveBookHelper(work, edition)
        s.save(formdata)

        assert web.ctx.site.get("/works/OL1W").title == "Original Work Title"
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="fbf3e1e6241bfd3002780bb9873c2233">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="299" endLineNumber="303"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="90" endLineNumber="94"/>
            <text>
<![CDATA[        formdata = web.storage(
            {
                "work--key": "/works/OL1W",
                "work--title": "Original Work Title",
                "edition--title": "Original Edition Title",
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="e191600fbdf5d3df3d1ca3d7ee339dfc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_processors_invalidation.py" startLineNumber="63" endLineNumber="67"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_processors_invalidation.py" startLineNumber="94" endLineNumber="98"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_processors_invalidation.py" startLineNumber="146" endLineNumber="150"/>
            <text>
<![CDATA[        assert self.hook.call_count == 1
        assert (
            self.hook.recent_doc.dict()
            == web.ctx.site.get("/templates/site.tmpl").dict()
        )
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="fc1ed451bbad10c0e032eb7b9b17e792">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="21" endLineNumber="25"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="94" endLineNumber="98"/>
            <text>
<![CDATA[            }
            assert ListRecord.from_input() == ListRecord(
                key=None,
                name='foo',
                description='bar',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="f97d61ea7588e605b657a6b93ce22b5b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="30" endLineNumber="34"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="9" endLineNumber="13"/>
            <text>
<![CDATA[def open_test_data(filename):
    """Returns a file handle to file with specified filename inside test_data directory."""
    root = os.path.dirname(__file__)
    fullpath = os.path.join(root, 'test_data', filename)
    return open(fullpath, mode='rb')
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="a24b9ea761e9d1a9bbe90a69d671038f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/vendors.py" startLineNumber="282" endLineNumber="286"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/vendors.py" startLineNumber="314" endLineNumber="318"/>
            <text>
<![CDATA[    id_: str,
    id_type: Literal['asin', 'isbn'] = 'isbn',
    resources: Any = None,
    high_priority: bool = False,
) -> dict | None:
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="763694a47f270df0c7f4b484d1152c93">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="389" endLineNumber="393"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="416" endLineNumber="420"/>
            <text>
<![CDATA[        assert len(list(self.db.select('bookshelves_events'))) == 7
        assert (
            len(
                list(
                    self.db.select(
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="1d194f1f2e0f00bba293e3fdab56c92c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1293" endLineNumber="1298"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1239" endLineNumber="1244"/>
            <text>
<![CDATA[    }

    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'modified'
    assert reply['work']['status'] == 'matched'
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="c62f4607e97e01d37a826cb3e91640c7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_sponsors.py" startLineNumber="8" endLineNumber="13"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_sponsors.py" startLineNumber="31" endLineNumber="36"/>
            <text>
<![CDATA[        user = storage(key='/person/mekBot')

        monkeypatch.setattr(
            sponsorships, 'get_internet_archive_id', lambda user_key: '@username'
        )
        assert sponsorships.get_internet_archive_id(user) == '@username'
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="fdc5111ed598c9bd24a933ec9a0c08d7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_match.py" startLineNumber="228" endLineNumber="232"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_match.py" startLineNumber="337" endLineNumber="341"/>
            <text>
<![CDATA[            'authors',
            'exact match',
            125,
        )
        threshold = 875
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="cbb4fe31976f0c4e226797d650ee8690">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_lcc.py" startLineNumber="86" endLineNumber="90"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/tests/test_lcc.py" startLineNumber="95" endLineNumber="99"/>
            <text>
<![CDATA[@pytest.mark.parametrize(
    "sortable_lcc,short_lcc,name",
    WAGNER_2019_EXAMPLES,
    ids=[t[-1] for t in WAGNER_2019_EXAMPLES],
)
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="44cc2fe282e860ef8760a11138c5a32f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="70" endLineNumber="75"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="1081" endLineNumber="1085"/>
            <text>
<![CDATA[        oldb = db.get_db()
        data = {
            'username': username,
            'work_id': work_id,
            'edition_id': edition_id,
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="e78536f4851e14ced71b2ccda7fcde62">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/db.py" startLineNumber="67" endLineNumber="71"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/db.py" startLineNumber="121" endLineNumber="125"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/db.py" startLineNumber="140" endLineNumber="144"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/bulkimport.py" startLineNumber="54" endLineNumber="58"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/bulkimport.py" startLineNumber="280" endLineNumber="284"/>
            <text>
<![CDATA[        except:
            t.rollback()
            raise
        else:
            t.commit()
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="594c53d05cadc5a26bfb37150651b47b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="182" endLineNumber="187"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="240" endLineNumber="245"/>
            <text>
<![CDATA[        username = user.key.split('/')[2]

        def response(msg, status="success"):
            return delegate.RawText(
                json.dumps({status: msg}), content_type="application/json"
            )
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="731ccbb2677aa1b2cb83980cea12c277">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="44" endLineNumber="48"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="65" endLineNumber="69"/>
            <text>
<![CDATA[    },
    {
        'id': 3,
        'batch_id': 2,
        'ia_id': 'unique_id_1',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="3f9f03d395d5fce8eb2870c4f87e94b6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="219" endLineNumber="223"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="855" endLineNumber="859"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="945" endLineNumber="950"/>
            <text>
<![CDATA[    }

    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'created'
    assert reply['work']['status'] == 'created'
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="becde19e664d61fc493f376b6c426d2d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="466" endLineNumber="470"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="476" endLineNumber="480"/>
            <text>
<![CDATA[            [],
            FakeDataProvider(),
            {},
        )
        assert wsb.number_of_pages_median is None
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="20ed67ea308633004b5220f56698dd02">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="377" endLineNumber="381"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="402" endLineNumber="406"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="445" endLineNumber="449"/>
            <text>
<![CDATA[        assert len(list(self.db.select('bookshelves_events'))) == 6
        assert (
            len(
                list(
                    self.db.select(
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="04b0c13d401885e185b5bad74e767580">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/subjects.py" startLineNumber="13" endLineNumber="17"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/subjects.py" startLineNumber="30" endLineNumber="34"/>
            <text>
<![CDATA[        'key',
        'name',
        'subject_type',
        'work_count',
    }
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="d7996ffdfd97b2ba48010c2db388fe48">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_utils.py" startLineNumber="195" endLineNumber="200"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_utils.py" startLineNumber="209" endLineNumber="214"/>
            <text>
<![CDATA[            },
        }
    )

    web.ctx.site.save(
        {
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="27f6af156225e04888e246af11674af4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="255" endLineNumber="259"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="240" endLineNumber="244"/>
            <text>
<![CDATA[        'key': '/books/OL1M',
        'title': 'test1',
        'type': '/type/edition',
        'work': {'key': '/works/OL1W'},
    }
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="35d7a3cc63c04e7657b00edf9f32dce1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="70" endLineNumber="75"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="134" endLineNumber="139"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="167" endLineNumber="172"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="204" endLineNumber="209"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="241" endLineNumber="246"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="278" endLineNumber="283"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="314" endLineNumber="319"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="350" endLineNumber="355"/>
            <text>
<![CDATA[        monkeypatch.setattr(accounts, "get_current_user", mock_user)

        web.ctx.site.save_many(
            [
                {
                    "type": {"key": "/type/work"},
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="ddb6d50dbc5cd17660ddce91bd2f7b4c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1181" endLineNumber="1186"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1120" endLineNumber="1125"/>
            <text>
<![CDATA[    }

    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'matched'
    assert reply['work']['status'] == 'modified'
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="9d763f8f2a27d50608bb57dc3f1ae49f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="389" endLineNumber="393"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="435" endLineNumber="439"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="254" endLineNumber="258"/>
            <text>
<![CDATA[        'authors': [{'key': '/authors/OL1A'}, {'key': '/authors/OL2A'}],
        'key': '/books/OL1M',
        'title': 'test1',
        'type': '/type/edition',
        'work': {'key': '/works/OL1W'},
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="c912b2e41fdca5228218b5f80195e36e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/form.py" startLineNumber="65" endLineNumber="69"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/form.py" startLineNumber="169" endLineNumber="173"/>
            <text>
<![CDATA[        for v in self.validators:
            if not v.valid(value):
                self.note = v.msg
                return False
        return True
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="05825c04484eb0b60d782046a949f3a0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="155" endLineNumber="159"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="191" endLineNumber="195"/>
            <text>
<![CDATA[                "work--title": "Modified Work Title",
                "edition--title": "Original Edition Title",
                "edition--works--0--key": "/works/OL1W",
            }
        )
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="b177fde14f99e87e1aa1ee8101a2e248">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="384" endLineNumber="388"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="394" endLineNumber="398"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="811" endLineNumber="816"/>
            <text>
<![CDATA[    marc = MarcBinary(open_test_data(src).read())
    rec = read_edition(marc)
    rec['source_records'] = ['marc:' + src]

    reply = load(rec)
    assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="22f28e3d4f67ea8ba49380a0132a6fd1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="543" endLineNumber="547"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="328" endLineNumber="332"/>
            <text>
<![CDATA[                username=username,
                bookshelf_id=bookshelf_id,
                work_id=work_id,
                edition_id=edition_id,
            )
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="f41253a42185ce0703bcd6df3428350b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="506" endLineNumber="510"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="723" endLineNumber="727"/>
            <text>
<![CDATA[        try:
            auth_header = http_basic_auth()
            self.login(auth_header)
        except accounts.ClientException:
            raise self.auth_failed("Invalid credentials")
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="2bf8d52ec184d58e73ed0f431eafc6f9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="140" endLineNumber="144"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="305" endLineNumber="309"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="171" endLineNumber="176"/>
            <text>
<![CDATA[        'title': 'Test item',
        'languages': ['eng'],
    }

    reply = load(rec)
    assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="ac4e5d8b68f0687d5153bf6c6a72df1d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1325" endLineNumber="1329"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1362" endLineNumber="1366"/>
            <text>
<![CDATA[                'isbn_10': ['1234567890'],
            },
            None,
        ),
        (
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="984799274ccfb167b5c7179d102417cc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="224" endLineNumber="228"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="236" endLineNumber="240"/>
            <text>
<![CDATA[        if 'query' in data:
            q = json.loads(data['query'])
            itemid = self._get_itemid(q.get('key'))
            if itemid:
                key = q['key']
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="a3e8afa405bdc3612b99169b907920a1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="578" endLineNumber="582"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/code.py" startLineNumber="602" endLineNumber="606"/>
            <text>
<![CDATA[    def GET(self, key):
        page = web.ctx.site.get(key)
        if not page:
            raise web.notfound('')
        else:
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="617d22cf86936774458b8f4abab76fc5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="134" endLineNumber="138"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="143" endLineNumber="147"/>
            <text>
<![CDATA[            [],
            FakeDataProvider(),
            {},
        )
        assert wsb.isbn == {'123456789X', '9781234567897'}
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="e0021c464c9f3d4c5fd8e88db94f94c8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1100" endLineNumber="1104"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1219" endLineNumber="1223"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1154" endLineNumber="1158"/>
            <text>
<![CDATA[        'publishers': ['Black Spot'],
        'type': {'key': '/type/edition'},
        'source_records': ['non-marc:test'],
        'publish_date': 'Jan 09, 2011',
        'isbn_10': ['1250144051'],
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="d2a1caa236f6993d8715d6ffe9502d6a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/authors.py" startLineNumber="1" endLineNumber="7"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/subjects.py" startLineNumber="1" endLineNumber="7"/>
            <text>
<![CDATA[from datetime import datetime
import logging
from collections.abc import Callable

from openlibrary.plugins.worksearch.schemes import SearchScheme

logger = logging.getLogger("openlibrary.worksearch")
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="902ff1600391e7efdb6fdfa67f80ff2b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/schema.py" startLineNumber="100" endLineNumber="104"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/schema.py" startLineNumber="154" endLineNumber="158"/>
            <text>
<![CDATA[        'float': 'float',
        'string': 'varchar',
        'text': 'text',
        'datetime': 'datetime',
        'timestamp': 'datetime',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="0fb75e9414afe4348e5b83fa3b03bfcc">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_models.py" startLineNumber="43" endLineNumber="47"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_models.py" startLineNumber="58" endLineNumber="62"/>
            <text>
<![CDATA[        assert repr(work) == str(work) == "<Work: '/works/OL42679M'>"
        assert isinstance(work, client.Thing)
        assert isinstance(work, models.Work)
        assert work._site == web.ctx.site
        assert work.key == '/works/OL42679M'
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="f4d7e6a6a08fd39e9d785cc812e580f4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="49" endLineNumber="53"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="76" endLineNumber="80"/>
            <text>
<![CDATA[            },
            {
                'key': '/works/OL456W',
                'type': 'work',
                'title': 'Foo Baz',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="e70f1c503b5551c37469806f36826ed5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="143" endLineNumber="147"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="308" endLineNumber="312"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="359" endLineNumber="363"/>
            <text>
<![CDATA[        reply = load(rec)
        assert reply['success'] is True
        assert reply['edition']['status'] == 'created'
        e = mock_site.get(reply['edition']['key'])
        assert e.type.key == '/type/edition'
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="8d8ca4b5f7e4dae03095a6c200e6aa1e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/borrow_home.py" startLineNumber="55" endLineNumber="59"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/borrow_home.py" startLineNumber="72" endLineNumber="76"/>
            <text>
<![CDATA[    d = {
        "book": loan['book'],
        "identifier": loan['ocaid'],
        "resource_type": loan['resource_type'],
        "t_start": t_start.isoformat(),
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="cbd4dcdb34756a3b103b240f486e271b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/accounts/model.py" startLineNumber="124" endLineNumber="128"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="24" endLineNumber="28"/>
            <text>
<![CDATA[        "_key": key,
        "_rev": None,
        "type": "account-link",
        "username": username,
        "email": email,
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="462fb01fc2c43fb3f034860b8dd69606">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="222" endLineNumber="228"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="455" endLineNumber="461"/>
            <text>
<![CDATA[    def url(self, suffix="", **params):
        return self.get_url(suffix, **params)

    def get_url_suffix(self):
        return self.title or "untitled"

    def __repr__(self):
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="368dfbbc540b20e730e7e24f961ee4c0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="308" endLineNumber="312"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="318" endLineNumber="322"/>
            <text>
<![CDATA[            publisher=i.publisher,
            publish_year=i.publish_year,
            id_name=i.id_name,
            id_value=i.id_value,
        )
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="6263d2b86ff3612d966f74fe9deda669">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/accounts/test_models.py" startLineNumber="58" endLineNumber="62"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/accounts/test_models.py" startLineNumber="74" endLineNumber="78"/>
            <text>
<![CDATA[            "username": "test",
            "itemname": "@test",
            "email": "test@example.com",
            "displayname": "Test User",
            "test": test,
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="25185d4c25474d60aa60e6d44383cab7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="37" endLineNumber="41"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="79" endLineNumber="83"/>
            <text>
<![CDATA[        'status': 'pending',
    },
    {
        'id': 2,
        'batch_id': 1,
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="24bc0f50c6c4dfd019ddf8ba1031429c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/schema.py" startLineNumber="106" endLineNumber="110"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/schema.py" startLineNumber="160" endLineNumber="164"/>
            <text>
<![CDATA[        'date': 'date',
        'binary': 'blob',
        'boolean': 'boolean',
    }
    constants = {
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="682e6a8a6bc8df346c38c30cdc0cd0a3">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="875" endLineNumber="879"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="950" endLineNumber="955"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/support.py" startLineNumber="45" endLineNumber="49"/>
            <text>
<![CDATA[            recap = get_recaptcha()
            if recap and not recap.validate():
                return render_template(
                    "message.html",
                    'Recaptcha solution was incorrect',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="e19e071712ed3d0116572c9a0ede5f3c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/civicrm.py" startLineNumber="19" endLineNumber="23"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/civicrm.py" startLineNumber="68" endLineNumber="72"/>
            <text>
<![CDATA[        "action": "get",
        "api_key": lending.config_ia_civicrm_api.get("api_key", ""),
        "key": lending.config_ia_civicrm_api.get("site_key", ""),
        "json": {
            "sequential": 1,
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="66de2098092b17aa393bbd4cdef6ff6c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1087" endLineNumber="1092"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="985" endLineNumber="989"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="871" endLineNumber="875"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="904" endLineNumber="908"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1039" endLineNumber="1044"/>
            <text>
<![CDATA[        'key': '/authors/OL20A',
    }

    existing_work = {
        'authors': [{'author': '/authors/OL20A', 'type': {'key': '/type/author_role'}}],
        'key': '/works/OL16W',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="c041f54544bd8e7bdf0166788dd9bbe9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="854" endLineNumber="859"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/code.py" startLineNumber="582" endLineNumber="587"/>
            <text>
<![CDATA[        if 'env' not in web.ctx:
            delegate.fakeload()

        keys = web.ctx.site.things(
            {
                "type": "/type/list",
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="686317943aebe8e475b0218c60f45c3e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="697" endLineNumber="702"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="719" endLineNumber="723"/>
            <text>
<![CDATA[                )
                current_observation = {
                    'label': observation_item['label'],
                    'description': observation_item['description'],
                    'multi_choice': observation_item['multi_choice'],
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="83669ef61bea1a2920abb93dcde88a87">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="266" endLineNumber="270"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="335" endLineNumber="339"/>
            <text>
<![CDATA[            "bib_key": "isbn:1234567890",
            "info_url": "https://openlibrary.org/books/OL1M/foo",
            "preview": "noview",
            "preview_url": "https://openlibrary.org/books/OL1M/foo",
        }
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="a534a037b02543d4547c51ebaf6001bd">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="189" endLineNumber="193"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="209" endLineNumber="214"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="232" endLineNumber="237"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="279" endLineNumber="283"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="303" endLineNumber="307"/>
            <text>
<![CDATA[        b = ol.browser()
        self.signup(
            b,
            displayname="Foo",
            username="foo",
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="4816987a7092bbb04164e19da6251b52">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="316" endLineNumber="320"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="375" endLineNumber="379"/>
            <text>
<![CDATA[            The reading log DB alone has access to who logged which book to their
            reading log, so we need to get work IDs and logged info from there, query
            Solr for more complete book information, and then put the logged info into
            the Solr response.
            """
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="1a7cd56c16b77dea6b308573e300c36c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="370" endLineNumber="374"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="419" endLineNumber="423"/>
            <text>
<![CDATA[        data = open_test_data(ia + '_meta.mrc').read()
        rec = read_edition(MarcBinary(data))
        rec['source_records'] = ['ia:' + ia]
        reply = load(rec)
        assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="231b19dc2a22265ffaf0c4f38d6b00d1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="64" endLineNumber="68"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="85" endLineNumber="89"/>
            <text>
<![CDATA[        'status': 'staged',
    },
    {
        'id': 3,
        'batch_id': 2,
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="c6b788f7004745bf4f83db6820535a1b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/booknotes.py" startLineNumber="31" endLineNumber="36"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/booknotes.py" startLineNumber="49" endLineNumber="54"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/ratings.py" startLineNumber="47" endLineNumber="52"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/ratings.py" startLineNumber="56" endLineNumber="61"/>
            <text>
<![CDATA[        if since:
            query += " WHERE created >= $since"
        results = oldb.query(query, vars={'since': since})
        return results[0]['count'] if results else 0

    @classmethod
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="a9ffdd3e5b93daf11edf95af1715bc27">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/readlinks.py" startLineNumber="76" endLineNumber="80"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/readlinks.py" startLineNumber="93" endLineNumber="97"/>
            <text>
<![CDATA[    )
    reply = requests.get(solr_select).json()
    if reply['response']['numFound'] == 0:
        return []
    rows = reply['response']['docs']
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="a67058a6282c09da970c7d962f55ff2e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="407" endLineNumber="411"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="439" endLineNumber="443"/>
            <text>
<![CDATA[            "key": "/works/OL123W",
            "type": "work",
            "language": ["eng"],
            "title": "The Celebrated Jumping Frog of Calaveras County",
        }
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="148f32ec39a9855db55c39545c472243">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/code.py" startLineNumber="146" endLineNumber="150"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/code.py" startLineNumber="193" endLineNumber="197"/>
            <text>
<![CDATA[                data,
                category=category,
                olid=i.olid,
                author=i.author,
                source_url=i.source_url,
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="65e9cf9e765c9694c128071040987163">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_home.py" startLineNumber="160" endLineNumber="164"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_home.py" startLineNumber="171" endLineNumber="175"/>
            <text>
<![CDATA[        book = mock_site.quicksave(
            "/books/OL1M",
            "/type/edition",
            title="Foo",
            authors=[{"key": "/authors/OL1A"}],
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="687a56fb5bf5a4c46d1bc83f576629ab">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/lending.py" startLineNumber="472" endLineNumber="476"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/lending.py" startLineNumber="491" endLineNumber="495"/>
            <text>
<![CDATA[        ocaids = [ocaid for ocaid in map(get_ocaid, items) if ocaid]
        availabilities = get_availability_of_ocaids(ocaids)
        for item in items:
            ocaid = get_ocaid(item)
            if ocaid:
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="5c947c54477185e428fe474e4f2e6d8d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="69" endLineNumber="73"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="44" endLineNumber="48"/>
            <text>
<![CDATA[                {
                    'key': '/works/OL123W',
                    'type': 'work',
                    'title': 'Foo Bar',
                    'subtitle': 'Baz',
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="a8e70fb2566a2e56f44ab3e6bf0b12ac">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="51" endLineNumber="55"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="84" endLineNumber="88"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="120" endLineNumber="124"/>
            <text>
<![CDATA[                "Condition": "",
                "Condition Description": "",
                "Date Added": "2020/12/13",
                "Date Read": "",
                "Exclusive Shelf": "to-read",
]]>
            </text>
        </set>
        <set lineCount="5" fingerprint="9f5cc579a6487cacfe940d10a517e738">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/tests/test_code.py" startLineNumber="10" endLineNumber="15"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/tests/test_code.py" startLineNumber="69" endLineNumber="74"/>
            <text>
<![CDATA[    """
    monkeypatch.setattr(web, "ctx", web.storage())
    web.ctx.lang = "eng"
    web.ctx.site = mock_site

    ia_metadata = {
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="f3911ce9364d3a6baf7e3636b359c015">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="339" endLineNumber="345"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="303" endLineNumber="309"/>
            <text>
<![CDATA[                "edition--title": "Original Edition Title",
                "edition--works--0--key": "/works/OL2W",
            }
        )

        s = addbook.SaveBookHelper(work, edition)
        s.save(formdata)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="295b3782faf21e69f968ce7e26fd918c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="54" endLineNumber="59"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="28" endLineNumber="33"/>
            <text>
<![CDATA[        return Response(
            400,
            request=MagicMock(),
            content=json.dumps(
                {
                    'responseHeader': {
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="6e4d8af218b8bd438f4ed5aa5c1698f9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="693" endLineNumber="698"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="682" endLineNumber="687"/>
            <text>
<![CDATA[                    {
                        "name": d.get('value') or '',
                        "label": d.get('label') or '',
                        "website": d.get("website") or '',
                        "notes": d.get("notes") or '',
                    }
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="a9fecfa30520e459e5cebbe057681744">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="88" endLineNumber="93"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="42" endLineNumber="47"/>
            <text>
<![CDATA[        mock_solr_select.return_value = {
            'docs': [
                {
                    'key': '/works/OL123W',
                    'type': 'work',
                    'title': 'Foo Bar',
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="fd82f1f8ab8626d593ee0375b6bd9de8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="141" endLineNumber="148"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="106" endLineNumber="113"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="95" endLineNumber="102"/>
            <text>
<![CDATA[        monkeypatch.setattr(httpx, "post", mock_post)

        solr_update(
            SolrUpdateRequest(commit=True),
            solr_base_url="http://localhost:8983/solr/foobar",
        )

        assert mock_post.call_count > 1
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="1c9571e52deb5c9f3e4a9ac580858ca7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="111" endLineNumber="117"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="90" endLineNumber="96"/>
            <text>
<![CDATA[        oldb = db.get_db()

        data = {
            'username': username,
            'event_type': event_type,
            'event_date': f'{year}%',
        }
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="4801b6059e07d7cecf76a6ae33e67741">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="413" endLineNumber="418"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="395" endLineNumber="400"/>
            <text>
<![CDATA[        author_key = "OL123A"
        author_name = "Samuel Clemens"
        author = web.ctx.site.new(
            "/authors/OL123A",
            {"key": author_key, "type": {"key": "/type/author"}, "name": author_name},
        )
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="a284f371f921763f569414273c388b60">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="452" endLineNumber="458"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="429" endLineNumber="435"/>
            <text>
<![CDATA[                "cover_url": "/images/icons/avatar_book-sm.png",
                "ia": [],
                "first_publish_year": None,
            }
        )

        assert addbook.make_work(doc) == web_doc
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="53bef0f4bc563d547b397d710e0b5ae0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="422" endLineNumber="427"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="405" endLineNumber="410"/>
            <text>
<![CDATA[            "author_key": ["OL123A"],
            "author_name": ["Samuel Clemens"],
            "key": "/works/OL123W",
            "type": "work",
            "language": ["eng"],
            "title": "The Celebrated Jumping Frog of Calaveras County",
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="3140836f142bb2cdd01c2dd8b4a78837">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="581" endLineNumber="587"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="245" endLineNumber="251"/>
            <text>
<![CDATA[    def get_ebook_info(self):
        """Returns the ebook info with the following fields.

        * read_url - url to read the book
        * borrow_url - url to borrow the book
        * borrowed - True if the book is already borrowed
        * daisy_url - url to access the daisy format of the book
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="dba222186447e5e1dbbbbc98bc787d4d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_query_utils.py" startLineNumber="4" endLineNumber="9"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="16" endLineNumber="21"/>
            <text>
<![CDATA[    luqum_parser,
    luqum_remove_child,
    luqum_replace_child,
    luqum_traverse,
    luqum_replace_field,
)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="71362a4005cc75593e1e9f9680cc5696">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="811" endLineNumber="817"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="394" endLineNumber="399"/>
            <text>
<![CDATA[        marc = MarcBinary(open_test_data(src).read())
        rec = read_edition(marc)
        rec['source_records'] = ['marc:' + src]
        reply = load(rec)
        assert reply['success'] is True
        assert reply['edition']['status'] == 'modified'
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="a24c2e45af970ddb4aceeadfed57a98e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_match.py" startLineNumber="141" endLineNumber="146"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/match.py" startLineNumber="149" endLineNumber="154"/>
            <text>
<![CDATA[        'lccn',
        'publishers',
        'publish_date',
        'number_of_pages',
        'authors',
        'contribs',
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="528db857880147b689dae3a8ad4178da">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="482" endLineNumber="487"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="287" endLineNumber="292"/>
            <text>
<![CDATA[    b'{Ecaron}': b'\xe9E',
    b'{Ecirc}': b'\xe3E',
    b'{Ecy}': b'\xe7E',
    b'{Egrave}': b'\xe1E',
    b'{Ehookr}': b'\xf1E',
    b'{Eogon}': b'\xf1E',
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="2c83500c1a12ad2b49d68d9e6dfa1c40">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="530" endLineNumber="535"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="521" endLineNumber="526"/>
            <text>
<![CDATA[        assert (
            len(
                list(
                    self.db.select(self.TABLENAME, where={'username': '@kilgore_trout'})
                )
            )
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="cab9d4384347dcb7373fabeb3b1dc827">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="76" endLineNumber="82"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="58" endLineNumber="64"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="41" endLineNumber="47"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="29" endLineNumber="35"/>
            <text>
<![CDATA[        oldb = db.get_db()

        where = 'username=$username AND year=$year'
        data = {
            'username': username,
            'year': year,
        }
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="19fcc9a04220b28fd15ca25d981512d9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="205" endLineNumber="210"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="181" endLineNumber="186"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_connections.py" startLineNumber="117" endLineNumber="122"/>
            <text>
<![CDATA[            "authors": [
                {
                    "type": {"key": "/type/author_role"},
                    "author": {"key": "/authors/OL2A"},
                }
            ],
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="e40ec09d5aee28752be61a632cc768d0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/cache.py" startLineNumber="324" endLineNumber="329"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/cache.py" startLineNumber="78" endLineNumber="83"/>
            <text>
<![CDATA[            else:
                web.debug(
                    "Could not find memcache_servers in the configuration. Used dummy memcache."
                )
                try:
                    import mockcache  # Only supports legacy Python
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="ba9aadb3a4516700713410073cc7f3d1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="122" endLineNumber="128"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="156" endLineNumber="162"/>
            <text>
<![CDATA[                "edition--title": "Original Edition Title",
                "edition--works--0--key": "/works/OL1W",
            }
        )

        s = addbook.SaveBookHelper(None, edition)
        s.save(formdata)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="1be0ba90617f2d09e8e404314ec2d255">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="1080" endLineNumber="1085"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="158" endLineNumber="163"/>
            <text>
<![CDATA[            u = self.key + suffix
        if params:
            u += '?' + urlencode(params)
        if not relative:
            u = _get_ol_base_url() + u
        return u
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="efddafe89b412645924e5d1895369307">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_processors_invalidation.py" startLineNumber="102" endLineNumber="112"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_processors_invalidation.py" startLineNumber="76" endLineNumber="86"/>
            <text>
<![CDATA[        mock_now = datetime.datetime.utcnow() - datetime.timedelta(seconds=60)
        monkeypatch.setattr(datetime, "datetime", MockDatetime(mock_now))

        p = invalidation.InvalidationProcessor(prefixes=['/templates'], timeout=60)

        # come back to real time
        monkeypatch.undo()

        # monkeypatch web
        self._monkeypatch_web(monkeypatch)
        self._monkeypatch_hooks(monkeypatch)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="5f7a874e53b7be33e5079a0884d8fa55">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/olmemcache.py" startLineNumber="20" endLineNumber="27"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/utils.py" startLineNumber="1283" endLineNumber="1290"/>
            <text>
<![CDATA[        try:
            value = self._client.get(web.safestr(key))
        except memcache.Client.MemcachedKeyError:
            return None

        return value and self.decompress(value)

    def get_multi(self, keys):
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="db8e863b3de5a45361b427a051cde055">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="197" endLineNumber="202"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_marc.py" startLineNumber="178" endLineNumber="183"/>
            <text>
<![CDATA[            },
        )
    ]
    for value, expect in data:
        output = read_title(MockRecord('245', value))
        assert output == expect
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="b42823253bf6e3e14692ffdc22147625">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/subjects.py" startLineNumber="37" endLineNumber="42"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/authors.py" startLineNumber="44" endLineNumber="49"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="265" endLineNumber="270"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/__init__.py" startLineNumber="106" endLineNumber="111"/>
            <text>
<![CDATA[    def q_to_solr_params(
        self,
        q: str,
        solr_fields: set[str],
        cur_solr_params: list[tuple[str, str]],
    ) -> list[tuple[str, str]]:
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="823adacae192726e0db8906c4cb2d16b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="325" endLineNumber="330"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="310" endLineNumber="315"/>
            <text>
<![CDATA[        if not web.ctx.site.can_write(key):
            return render_template(
                "permission_denied",
                web.ctx.fullpath,
                f"Permission denied to edit {key}.",
            )
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="28defa71b509b9b3e0d7d1b9eb5d4e77">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="253" endLineNumber="258"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="235" endLineNumber="240"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="192" endLineNumber="197"/>
            <text>
<![CDATA[        w = make_work()
        d = WorkSolrBuilder(
            work=w,
            editions=[make_edition(w, key="/books/OL1M", ocaid='foo00bar')],
            authors=[],
            data_provider=FakeDataProvider(),
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="cdbc60f11cbf38eeeba7f29b7c0a7251">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/olmemcache.py" startLineNumber="10" endLineNumber="16"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/utils.py" startLineNumber="1264" endLineNumber="1270"/>
            <text>
<![CDATA[    Compatible with memcache Client API.
    """

    def __init__(self, servers):
        self._client = memcache.Client(servers)
        compressor = OLCompressor()
        self.compress = compressor.compress
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="88d528553a70ef9c077076c422960335">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="128" endLineNumber="135"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="117" endLineNumber="124"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_utils.py" startLineNumber="84" endLineNumber="91"/>
            <text>
<![CDATA[        monkeypatch.setattr(httpx, "post", mock_post)

        solr_update(
            SolrUpdateRequest(commit=True),
            solr_base_url="http://localhost:8983/solr/foobar",
        )

        assert mock_post.call_count == 1
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="2e0e08e4482999ba5f9c4f2396a58e02">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="762" endLineNumber="767"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/lists.py" startLineNumber="752" endLineNumber="757"/>
            <text>
<![CDATA[                lst,
                data["editions"],
                data["works"],
                data["authors"],
            )
            return delegate.RawText(html)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="e6f82cf36d1b6b87ea0e32679402c78b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1218" endLineNumber="1223"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1099" endLineNumber="1104"/>
            <text>
<![CDATA[        'title': 'Finding Existing Works',
        'publishers': ['Black Spot'],
        'type': {'key': '/type/edition'},
        'source_records': ['non-marc:test'],
        'publish_date': 'Jan 09, 2011',
        'isbn_10': ['1250144051'],
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="f4f0d7370dfae4af4ae22dba76e26ca9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/authors.py" startLineNumber="36" endLineNumber="41"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/authors.py" startLineNumber="16" endLineNumber="21"/>
            <text>
<![CDATA[        'birth_date',
        'death_date',
        'date',
        'top_subjects',
        'work_count',
    }
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="cde06cd873c79a2f109d99a0b1629bb0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="358" endLineNumber="364"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="224" endLineNumber="230"/>
            <text>
<![CDATA[        },
    ]

    @classmethod
    def setup_class(cls):
        web.config.db_parameters = {"dbn": "sqlite", "db": ":memory:"}
        db = get_db()
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="da0c35ef88789e38d8bccfc9310e3b4e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="878" endLineNumber="884"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="191" endLineNumber="197"/>
            <text>
<![CDATA[        lists = self._site.get_many(keys)
        if sort:
            lists = safesort(lists, reverse=True, key=lambda list: list.last_modified)
        return lists

    @cache.memoize(engine="memcache", key=lambda self: ("d" + self.key, "l"))
    def _get_lists_cached(self):
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="6a5b112552ee9ed0c56bde0a80e6b4fe">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="101" endLineNumber="106"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/numbers.py" startLineNumber="75" endLineNumber="80"/>
            <text>
<![CDATA[    """
    try:
        start = kargs['start'].strftime("%Y-%m-%d")
        end = kargs['end'].strftime("%Y-%m-%d %H:%M:%S")
        db = kargs['thingdb']
    except KeyError as k:
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="19d7b74a10489d75f04872b44295381a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="135" endLineNumber="140"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="62" endLineNumber="67"/>
            <text>
<![CDATA[            "links": [
                {
                    "title": "wikipedia article",
                    "url": "http://en.wikipedia.org/wiki/foo",
                }
            ],
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="336797ebec388677f45c936420567277">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/schema.py" startLineNumber="135" endLineNumber="140"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/schema.py" startLineNumber="108" endLineNumber="113"/>
            <text>
<![CDATA[        'boolean': 'boolean',
    }
    constants = {
        'CURRENT_TIMESTAMP': 'CURRENT_TIMESTAMP',
        'CURRENT_DATE': 'CURRENT_DATE',
        'CURRENT_TIME': 'CURRENT_TIME',
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="27cbea8b3b0e945e2cc559b8126b70ed">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/solr/updater/list.py" startLineNumber="53" endLineNumber="58"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/solr/updater/author.py" startLineNumber="15" endLineNumber="20"/>
            <text>
<![CDATA[        async with httpx.AsyncClient() as client:
            response = await client.get(
                base_url,
                params=[  # type: ignore[arg-type]
                    ('wt', 'json'),
                    ('json.nl', 'arrarr'),
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="164748cc1c5d8656fd95551b7b40f11a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="357" endLineNumber="362"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="321" endLineNumber="326"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="285" endLineNumber="290"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="248" endLineNumber="253"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="211" endLineNumber="216"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="174" endLineNumber="179"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="141" endLineNumber="146"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="77" endLineNumber="82"/>
            <text>
<![CDATA[                    "title": "Original Work Title",
                },
                {
                    "type": {"key": "/type/edition"},
                    "key": "/books/OL1M",
                    "title": "Original Edition Title",
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="cd612f7b53ee5b552fc0eddd8bb416af">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="208" endLineNumber="213"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="81" endLineNumber="86"/>
            <text>
<![CDATA[        {
            'time': {'Civil War, 1861-1865': 2},
            'place': {'United States': 2, 'Confederate States of America': 1},
            'subject': {'Sources': 2, 'Regimental histories': 1, 'History': 3},
        },
    ),
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="f295e5595db9d5958ab94faa70ccb384">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/olmarkdown.py" startLineNumber="57" endLineNumber="64"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/olmarkdown.py" startLineNumber="1" endLineNumber="8"/>
            <text>
<![CDATA["""Open Library Flavored Markdown, inspired by [Github Flavored Markdown][GFM].

GFM: http://github.github.com/github-flavored-markdown/

Differences from traditional Markdown:
* new lines in paragraph are treated as line breaks
* URLs are autolinked
* generated HTML is sanitized
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="89c9d6afe584531f4f6440b946710082">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="148" endLineNumber="154"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="114" endLineNumber="120"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="50" endLineNumber="56"/>
            <text>
<![CDATA[            ]
        )
        edition = web.ctx.site.get("/books/OL1M")

        formdata = web.storage(
            {
                "work--key": "",
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="d38ca04b45a2865aae1dd7c1968caaf6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/mocks/mock_infobase.py" startLineNumber="99" endLineNumber="104"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/mocks/mock_infobase.py" startLineNumber="78" endLineNumber="83"/>
            <text>
<![CDATA[        changeset = self._make_changeset(
            timestamp=timestamp,
            kind=action,
            comment=comment,
            data=data,
            changes=changes,
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="83fd2969d9794ced0d3fb073f3b52f3a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/conftest.py" startLineNumber="26" endLineNumber="33"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/conftest.py" startLineNumber="11" endLineNumber="18"/>
            <text>
<![CDATA[    f = open(cronfile, "w")
    f.write(ip)
    f.close()
    request.addfinalizer(lambda: os.remove(cronfile))
    return cronfile


@pytest.fixture()
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="f54805685c21a86c01d68213716abde7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/recentchanges.py" startLineNumber="150" endLineNumber="155"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/recentchanges.py" startLineNumber="124" endLineNumber="129"/>
            <text>
<![CDATA[    def GET(self, id):
        id = int(id)
        change = web.ctx.site.get_change(id)
        if not change:
            web.ctx.status = "404 Not Found"
            return render.notfound(web.ctx.path)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="22fc1c01a70011bed554167267f90467">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="903" endLineNumber="908"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/booknotes.py" startLineNumber="82" endLineNumber="87"/>
            <text>
<![CDATA[        """
        oldb = db.get_db()
        data = {'username': username}
        query = """
            SELECT
                COUNT(DISTINCT(work_id))
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="f3c59db2aec9bf90200bc84d996e724b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="171" endLineNumber="176"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/connection.py" startLineNumber="161" endLineNumber="166"/>
            <text>
<![CDATA[        keys_json = ConnectionMiddleware.things(
            self, sitename, {"query": json.dumps(q)}
        )
        keys = json.loads(keys_json)
        if keys:
            return keys[0]
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="a6fa3435f5e5d7ab62b76647346f9d91">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1403" endLineNumber="1410"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1278" endLineNumber="1285"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1159" endLineNumber="1166"/>
            <text>
<![CDATA[        'works': [{'key': '/works/OL1W'}],
    }

    mock_site.save(author)
    mock_site.save(existing_work)
    mock_site.save(existing_edition)

    rec = {
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="ea441a16c8c6483455bf1ff24bd261ab">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_connections.py" startLineNumber="79" endLineNumber="86"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_connections.py" startLineNumber="25" endLineNumber="32"/>
            <text>
<![CDATA[        conn = connections.MigrationMiddleware(MockConnection())

        def add(doc):
            conn.conn.docs[doc['key']] = doc

        def get(key):
            json_data = conn.request("openlibrary.org", "/get", data={"key": key})
            return json.loads(json_data)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="db61e087552f4d18172f7a31fcab0eb5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addtag.py" startLineNumber="134" endLineNumber="140"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="993" endLineNumber="999"/>
            <text>
<![CDATA[            raise web.notfound()

        i = web.input(_comment=None)
        formdata = self.process_input(i)
        try:
            if not formdata:
                raise web.badrequest()
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="3baac29337f70e80aebb7c3d7f7cf839">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="43" endLineNumber="48"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/editions.py" startLineNumber="16" endLineNumber="21"/>
            <text>
<![CDATA[        "title",
        "subtitle",
        "alternative_title",
        "alternative_subtitle",
        "cover_i",
        "ebook_access",
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="9e3b6b9e1c76e572eff299370f524e2b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="333" endLineNumber="338"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="313" endLineNumber="318"/>
            <text>
<![CDATA[    expected_result = {
        "isbn:1234567890": {
            "bib_key": "isbn:1234567890",
            "info_url": "https://openlibrary.org/books/OL1M/foo",
            "preview": "noview",
            "preview_url": "https://openlibrary.org/books/OL1M/foo",
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="63d136f2a9793401a44a807b04493694">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_processors_invalidation.py" startLineNumber="143" endLineNumber="150"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_processors_invalidation.py" startLineNumber="93" endLineNumber="98"/>
            <text>
<![CDATA[        p(lambda: None)
        assert self.hook.call_count == 1
        assert (
            self.hook.recent_doc.dict()
            == web.ctx.site.get("/templates/site.tmpl").dict()
        )
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="3f01c2517e5b30b7c6dd33468b37953a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="617" endLineNumber="622"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="608" endLineNumber="613"/>
            <text>
<![CDATA[        assert (
            len(
                list(
                    self.db.select(self.TABLENAME, where={'username': '@billy_pilgrim'})
                )
            )
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="c163059c45b93aed90f3ff07cb22fa47">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="193" endLineNumber="200"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="267" endLineNumber="274"/>
            <text>
<![CDATA[                "edition--works--0--key": "/works/OL1W",
            }
        )

        s = addbook.SaveBookHelper(work, edition)
        s.save(formdata)

        assert web.ctx.site.get("/works/OL1W").title == "Modified Work Title"
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="a1760f531f2a02e0d6d456a076580ebd">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="751" endLineNumber="757"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="670" endLineNumber="676"/>
            <text>
<![CDATA[    src = ia + '_meta.mrc'
    marc = MarcBinary(open_test_data(src).read())
    rec = read_edition(marc)
    rec['source_records'] = ['ia:' + ia]

    reply = load(rec)
    assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="aea9e7800ef5624c66ca0bef369eb6f7">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="266" endLineNumber="272"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="229" endLineNumber="235"/>
            <text>
<![CDATA[                "edition--title": "Modified Edition Title",
                "edition--works--0--key": "/works/OL1W",
            }
        )

        s = addbook.SaveBookHelper(work, edition)
        s.save(formdata)
]]>
            </text>
        </set>
        <set lineCount="6" fingerprint="614f5dbb83c7610520365a4e795729ce">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/solr/updater/work.py" startLineNumber="508" endLineNumber="513"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/solr/updater/work.py" startLineNumber="498" endLineNumber="503"/>
            <text>
<![CDATA[        if (
            not self._ia_editions
            or self._ia_editions[0].ebook_access <= bp.EbookAccess.PRINTDISABLED
        ):
            return None
        else:
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="48c8a7e9ddb18d61834f000600fc2a7c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="942" endLineNumber="949"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="919" endLineNumber="926"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="885" endLineNumber="892"/>
            <text>
<![CDATA[        'publishers': ['Black Spot'],
        'publish_date': 'Jan 09, 2011',
        'isbn_10': ['1250144051'],
    }

    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'created'
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="5cebd329dc3d946317cc9b6cbb087ae9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/olbase/tests/test_events.py" startLineNumber="18" endLineNumber="24"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/olbase/tests/test_events.py" startLineNumber="37" endLineNumber="43"/>
            <text>
<![CDATA[                {
                    "key": "/people/anand/lists/OL1L",
                    "type": {"key": "/type/list"},
                    "revision": 1,
                    "seeds": [{"key": "/books/OL1M"}, "subject:love"],
                }
            ],
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="bc9688ab1035e6cf3c9bd141f2e6469b">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_opds.py" startLineNumber="49" endLineNumber="59"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_rdf.py" startLineNumber="67" endLineNumber="77"/>
            <text>
<![CDATA[    '{http://RDVocab.info/elements/}placeOfPublication': [
        'publish_place',
        parse_string,
    ],
}
# TODO: {http://purl.org/dc/terms/}identifier (could be ocaid)
# TODO: {http://www.w3.org/2005/Atom}link     (could be cover image)


def parse(root):
    edition_builder = import_edition_builder.import_edition_builder()
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="194620167577eaee8a44d13f25d7e6b6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="363" endLineNumber="369"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/api.py" startLineNumber="596" endLineNumber="602"/>
            <text>
<![CDATA[                {
                    "type": "/type/edition",
                    "works": work.key,
                    "limit": limit,
                    "offset": offset,
                }
            )
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="6f7baf9248e293ebf7a7f2aeb3d5e332">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/mocks/tests/test_mock_infobase.py" startLineNumber="78" endLineNumber="84"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_home.py" startLineNumber="148" endLineNumber="154"/>
            <text>
<![CDATA[        a2 = mock_site.quicksave("/authors/OL2A", "/type/author", name="A2")
        work = mock_site.quicksave(
            "/works/OL1W",
            "/type/work",
            title="Foo",
            authors=[{"author": {"key": "/authors/OL2A"}}],
        )
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="0e771b7ee0ee0f69f4793fa1d93b8bee">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="846" endLineNumber="853"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="927" endLineNumber="934"/>
            <text>
<![CDATA[        v = i.v and safeint(i.v, None)

        if not web.ctx.site.can_write(key):
            return render_template(
                "permission_denied",
                web.ctx.fullpath,
                "Permission denied to edit " + key + ".",
            )
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="c3664981c94d574372612628b1473e64">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="209" endLineNumber="215"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="549" endLineNumber="555"/>
            <text>
<![CDATA[    def _get_d(self):
        """Returns the data that goes into memcache as d/$self.key.
        Used to measure the memcache usage.
        """
        return {
            "h": self._get_history_preview(),
            "l": self._get_lists_cached(),
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="6d9e40a255d6fd2a1b6b8169190340a2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/dynlinks.py" startLineNumber="240" endLineNumber="246"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/models.py" startLineNumber="408" endLineNumber="414"/>
            <text>
<![CDATA[        def row(r):
            if isinstance(r, str):
                level = 0
                label = ""
                title = r
                pagenum = ""
            else:
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="57c66534fc07400a597fd74e402cb826">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/match.py" startLineNumber="245" endLineNumber="251"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/match.py" startLineNumber="264" endLineNumber="270"/>
            <text>
<![CDATA[    """
    :param dict e1: Expanded Edition, output of expand_record()
    :param dict e2: Expanded Edition, output of expand_record()
    :rtype: list
    :return: a list of tuples (field/category, result str, score int)
    """
    score = []
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="d6893b2f3d68c0665fc9a9709abfaf6e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_related_carousels.py" startLineNumber="16" endLineNumber="22"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_related_carousels.py" startLineNumber="47" endLineNumber="53"/>
            <text>
<![CDATA[        "Supernatural",
        "Scottish Horror tales",
        "Horror fiction",
        "Mystery and detective stories",
        "Physicians",
        "Horror",
        "Classic Literature",
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="7be70d2d89d4bc0f91f6af3dfc2ac669">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/stats.py" startLineNumber="149" endLineNumber="155"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/admin/stats.py" startLineNumber="161" endLineNumber="167"/>
            <text>
<![CDATA[    data.update(
        run_gathering_functions(
            infobase_db,
            coverstore_db,
            yesterday,
            today,
            logroot,
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="6fecab26e0980a74600079e744ae2510">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/edits.py" startLineNumber="175" endLineNumber="183"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/edits.py" startLineNumber="136" endLineNumber="144"/>
            <text>
<![CDATA[        else:
            resp = response(
                status='error',
                error=f'Action "{action}" is invalid for this request type.',
            )

        return resp

    @staticmethod
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="414efa9048e32f0b7ec16d7ffe566105">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="977" endLineNumber="983"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addtag.py" startLineNumber="117" endLineNumber="123"/>
            <text>
<![CDATA[    def GET(self, key):
        if not web.ctx.site.can_write(key):
            return render_template(
                "permission_denied",
                web.ctx.fullpath,
                "Permission denied to edit " + key + ".",
            )
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="a8de299fafc602af10e5d26bd9a5bbdb">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1600" endLineNumber="1606"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1607" endLineNumber="1613"/>
            <text>
<![CDATA[                {
                    'title': 'second title',
                    'source_records': ['ia:someid'],
                    'publishers': ['a publisher'],
                    'authors': [{'name': 'an author'}],
                    'publish_date': '2000',
                },
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="558c588bbc7f1e3257922a7f6c0a42e8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="373" endLineNumber="380"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="388" endLineNumber="395"/>
            <text>
<![CDATA[    monkeypatch_ol(monkeypatch)

    expected_result = {
        "OL2M": {
            "bib_key": "OL2M",
            "info_url": "https://openlibrary.org/books/OL2M/bar",
            "preview": "full",
            "preview_url": "https://archive.org/details/ia-bar",
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="26a1671fc6e61e44c4e42eef05692228">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="82" endLineNumber="88"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="118" endLineNumber="124"/>
            <text>
<![CDATA[                "Bookshelves": "to-read",
                "Bookshelves with positions": "to-read (#1)",
                "Condition": "",
                "Condition Description": "",
                "Date Added": "2020/12/13",
                "Date Read": "",
                "Exclusive Shelf": "to-read",
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="312959f2233d768082d0214ffe152dcb">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/dynlinks.py" startLineNumber="76" endLineNumber="82"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/readlinks.py" startLineNumber="23" endLineNumber="29"/>
            <text>
<![CDATA[def ol_query(name, value):
    query = {
        'type': '/type/edition',
        name: value,
    }
    if keys := web.ctx.site.things(query):
        return keys[0]
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="c52c32f5068d1a707e3a74e57fcc8d18">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="435" endLineNumber="442"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="490" endLineNumber="496"/>
            <text>
<![CDATA[            account.send_verification_email()
            title = _("Hi, %(user)s", user=account.displayname)
            message = _(
                "We've sent the verification email to %(email)s. You'll need to read that and click on the verification link to verify your email.",
                email=account.email,
            )
            return render.message(title, message)
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="1a312c02417bdb4c1ba0353b2b4e766d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="16" endLineNumber="22"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="35" endLineNumber="41"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="62" endLineNumber="68"/>
            <text>
<![CDATA[            mock_web_input.return_value = {
                'key': None,
                'name': 'foo',
                'description': 'bar',
                'seeds': [],
            }
            assert ListRecord.from_input() == ListRecord(
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="ebb27e691faaeb806fc59e68cb6ded30">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/statsdb.py" startLineNumber="28" endLineNumber="35"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/statsdb.py" startLineNumber="54" endLineNumber="61"/>
            <text>
<![CDATA[    """
    jsontext = json.dumps(data)
    timestamp = timestamp or datetime.datetime.utcnow()
    t = timestamp.isoformat()

    db = get_db()
    result = db.query("SELECT * FROM stats WHERE key=$key", vars=locals())
    if result:
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="afb487515c9ef583fefd73b675aefd4a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/booknotes.py" startLineNumber="139" endLineNumber="145"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="964" endLineNumber="970"/>
            <text>
<![CDATA[        """
        oldb = db.get_db()
        data = {'username': username, 'limit': limit, 'offset': limit * (page - 1)}
        query = """
            SELECT
                work_id,
                JSON_AGG(ROW_TO_JSON(
]]>
            </text>
        </set>
        <set lineCount="7" fingerprint="8b7ff8b125ffe1a0499288d4297d15df">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="387" endLineNumber="393"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/mnemonics.py" startLineNumber="662" endLineNumber="668"/>
            <text>
<![CDATA[    b'{t}': b't',
    b'{uacute}': b'\xe2u',
    b'{ubrevecy}': b'\xe6u',
    b'{ucirc}': b'\xe3u',
    b'{ucy}': b'u',
    b'{udblac}': b'\xeeu',
    b'{ugrave}': b'\xe1u',
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="ef4f5cb40ba78516d79726a221c0ab12">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="446" endLineNumber="453"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="403" endLineNumber="410"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="458" endLineNumber="465"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="417" endLineNumber="424"/>
            <text>
<![CDATA[        assert (
            len(
                list(
                    self.db.select(
                        'bookshelves_events', where={"username": "@kilgore_trout"}
                    )
                )
            )
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="42fde3880a87d888de67780678edbf31">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="378" endLineNumber="385"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="390" endLineNumber="397"/>
            <text>
<![CDATA[        assert (
            len(
                list(
                    self.db.select(
                        'bookshelves_events', where={"username": "@billy_pilgrim"}
                    )
                )
            )
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="5520e53d3369d9fe50ee992479f523e9">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/models.py" startLineNumber="413" endLineNumber="421"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/merge_authors.py" startLineNumber="220" endLineNumber="228"/>
            <text>
<![CDATA[            pagenum = ""
        else:
            level = safeint(r.get('level', '0'), 0)
            label = r.get('label', '')
            title = r.get('title', '')
            pagenum = r.get('pagenum', '')

        r = web.storage(level=level, label=label, title=title, pagenum=pagenum)
        return r
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="96e55de8093548b1b2202a47047edb0c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/cache.py" startLineNumber="395" endLineNumber="405"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/cache.py" startLineNumber="296" endLineNumber="306"/>
            <text>
<![CDATA[    def get(self, key):
        return self.d.get(key)

    def set(self, key, value, expires=0):
        self.d[key] = value

    def add(self, key, value, expires=0):
        return self.d.setdefault(key, value) is value

    def delete(self, key):
        return self.d.pop(key, None) is not None
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="c46faa3bbeb09756fa8eda9748bac9a8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="34" endLineNumber="41"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/tests/test_autocomplete.py" startLineNumber="11" endLineNumber="18"/>
            <text>
<![CDATA[    with (
        patch('web.input') as mock_web_input,
        patch('web.header'),
        patch('openlibrary.utils.solr.Solr.select') as mock_solr_select,
        patch('openlibrary.plugins.worksearch.autocomplete.get_solr') as mock_get_solr,
    ):
        mock_get_solr.return_value = Solr('http://foohost:8983/solr')
        mock_web_input.return_value = web.storage(q='foo', limit=5)
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="a9702c5baf4fb99647f91cadce5c421e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_stats.py" startLineNumber="11" endLineNumber="19"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_home.py" startLineNumber="11" endLineNumber="19"/>
            <text>
<![CDATA[class MockDoc(dict):
    def __init__(self, _id, *largs, **kargs):
        self.id = _id
        kargs['_key'] = _id
        super().__init__(*largs, **kargs)

    def __repr__(self):
        o = super().__repr__()
        return f"<{self.id} - {o}>"
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="21af90a9597c650cb45277666720f238">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_home.py" startLineNumber="97" endLineNumber="104"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/admin.py" startLineNumber="166" endLineNumber="173"/>
            <text>
<![CDATA[        'members': Stats(docs, "members", "total_members"),
        'works': Stats(docs, "works", "total_works"),
        'editions': Stats(docs, "editions", "total_editions"),
        'ebooks': Stats(docs, "ebooks", "total_ebooks"),
        'covers': Stats(docs, "covers", "total_covers"),
        'authors': Stats(docs, "authors", "total_authors"),
        'subjects': Stats(docs, "subjects", "total_subjects"),
    }
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="d59d75a9ba126e38f7cb1fcdd91816cf">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="62" endLineNumber="69"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="16" endLineNumber="23"/>
            <text>
<![CDATA[            mock_web_input.return_value = {
                'key': None,
                'name': 'foo',
                'description': 'bar',
                'seeds': [],
            }
            assert ListRecord.from_input() == ListRecord(
                key=None,
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="a903b5b8a88aa5292b83293f65620979">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_imports.py" startLineNumber="13" endLineNumber="20"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/schema.py" startLineNumber="91" endLineNumber="98"/>
            <text>
<![CDATA[        status text default 'pending',
        error text,
        ia_id text,
        data text,
        ol_key text,
        comments text,
        UNIQUE (batch_id, ia_id)
    );
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="92c131a165fafae4309d87b02834cb13">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1036" endLineNumber="1044"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="901" endLineNumber="908"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="868" endLineNumber="875"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1084" endLineNumber="1092"/>
            <text>
<![CDATA[    author = {
        'type': {'key': '/type/author'},
        'name': 'John Smith',
        'key': '/authors/OL20A',
    }

    existing_work = {
        'authors': [{'author': '/authors/OL20A', 'type': {'key': '/type/author_role'}}],
        'key': '/works/OL16W',
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="970e612285829dd5b8abee26baa71b47">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="703" endLineNumber="710"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="539" endLineNumber="546"/>
            <text>
<![CDATA[        auth_str = auth_str.replace("Basic ", "")
        try:
            auth_str = base64.decodebytes(bytes(auth_str, 'utf-8'))
            auth_str = auth_str.decode('utf-8')
        except AttributeError:
            auth_str = base64.decodestring(auth_str)
        username, password = auth_str.split(':')
        accounts.login(username, password)
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="5a0d682440eb97fe90c0fcde263ee3cf">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/subjects.py" startLineNumber="23" endLineNumber="30"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/authors.py" startLineNumber="27" endLineNumber="34"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="150" endLineNumber="157"/>
            <text>
<![CDATA[        'random': 'random_1 asc',
        'random asc': 'random_1 asc',
        'random desc': 'random_1 desc',
        'random.hourly': lambda: f'random_{datetime.now():%Y%m%dT%H} asc',
        'random.daily': lambda: f'random_{datetime.now():%Y%m%d} asc',
    }
    default_fetched_fields = {
        'key',
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="d577c304d023bd85e5a2eaf6061c6c6c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="127" endLineNumber="134"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="91" endLineNumber="98"/>
            <text>
<![CDATA[                "My Rating": "0",
                "My Review": "",
                "Number of Pages": "352",
                "Original Publication Year": "2019",
                "Original Purchase Date": "",
                "Original Purchase Location": "",
                "Owned Copies": "0",
                "Private Notes": "",
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="5d7f822f80605200ae06a83a3e6e7843">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="566" endLineNumber="573"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/updater/test_work.py" startLineNumber="550" endLineNumber="557"/>
            <text>
<![CDATA[        wsb = WorkSolrBuilder(
            work={},
            editions=[
                {"key": "/books/OL789M", "ocaid": "foobargoog"},
                {"key": "/books/OL789M", "ocaid": "foobarblah"},
            ],
            authors=[],
            data_provider=FakeDataProvider(),
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="ffa61f57308f96a92841d0cc67fb8222">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="203" endLineNumber="210"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="183" endLineNumber="190"/>
            <text>
<![CDATA[        'identifiers': {
            "oclc_numbers": ['1234'],
            "isbn_10": ['1234567890'],
            "isbn_13": ['1234567890123'],
            "lccn": ['5678'],
            "ocaid": ['90'],
        },
    }
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="2f1a0ff4060b0a51a0588717ace5a7aa">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_match.py" startLineNumber="319" endLineNumber="326"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_match.py" startLineNumber="303" endLineNumber="310"/>
            <text>
<![CDATA[            'authors': [
                {
                    'birth_date': '1897',
                    'entity_type': 'person',
                    'name': 'Green, Constance McLaughlin',
                    'personal_name': 'Green, Constance McLaughlin',
                }
            ],
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="07a3dbce0fcb072245a8fefd92b7a0d3">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1278" endLineNumber="1287"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1159" endLineNumber="1168"/>
            <text>
<![CDATA[        'works': [{'key': '/works/OL1W'}],
    }

    mock_site.save(author)
    mock_site.save(existing_work)
    mock_site.save(existing_edition)

    rec = {
        'authors': [{'name': 'John Smith'}],
        'isbn_10': ['1250144051'],
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="b2c13187882fa0ba99c626c2492ccdf4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_unmarshal.py" startLineNumber="9" endLineNumber="20"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/api.py" startLineNumber="284" endLineNumber="295"/>
            <text>
<![CDATA[class Text(str):
    __slots__ = ()

    def __repr__(self):
        return "<text: %s>" % str.__repr__(self)


class Reference(str):
    __slots__ = ()

    def __repr__(self):
        return "<ref: %s>" % str.__repr__(self)
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="ad7716c00451d6b723a4ae5a5fab12a2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1382" endLineNumber="1390"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1256" endLineNumber="1264"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1137" endLineNumber="1145"/>
            <text>
<![CDATA[    author = {
        'type': {'key': '/type/author'},
        'name': 'John Smith',
        'key': '/authors/OL1A',
    }

    existing_work = {
        'authors': [{'author': '/authors/OL1A', 'type': {'key': '/type/author_role'}}],
        'key': '/works/OL1W',
]]>
            </text>
        </set>
        <set lineCount="8" fingerprint="25eb3b39acadaca4eb44d827d8c75a0a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1202" endLineNumber="1210"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1083" endLineNumber="1091"/>
            <text>
<![CDATA[    """
    author = {
        'type': {'key': '/type/author'},
        'name': 'John Smith',
        'key': '/authors/OL20A',
    }

    existing_work = {
        'authors': [{'author': '/authors/OL20A', 'type': {'key': '/type/author_role'}}],
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="7d0465abf66f3b2f4befb2532cc1555a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="11" endLineNumber="19"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_lists.py" startLineNumber="84" endLineNumber="92"/>
            <text>
<![CDATA[        with (
            patch('web.input') as mock_web_input,
            patch('web.data') as mock_web_data,
        ):
            mock_web_data.return_value = b''
            mock_web_input.return_value = {
                'key': None,
                'name': 'foo',
                'description': 'bar',
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="bda0621dd215535f236dccff740b17d5">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="86" endLineNumber="94"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_vendors.py" startLineNumber="132" endLineNumber="140"/>
            <text>
<![CDATA[        'Last Days at Hot Slit',
        'The Radical Feminism of Andrea Dworkin',
    ],
    [
        'Bloody Times: The Funeral of Abraham Lincoln and the Manhunt for Jefferson Davis',
        'Bloody Times',
        'The Funeral of Abraham Lincoln and the Manhunt for Jefferson Davis',
    ],
]
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="dabc0750d9774a202cd1e9c7e6c28488">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="355" endLineNumber="364"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves.py" startLineNumber="424" endLineNumber="433"/>
            <text>
<![CDATA[            solr_docs = add_reading_log_data(reading_log_books, solr_docs)

            return LoggedBooksData(
                username=username,
                q=q,
                page_size=limit,
                total_results=total_results,
                shelf_totals=shelf_totals,
                docs=solr_docs,
            )
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="8744dcf1ed7b32a560a108a23c191047">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="150" endLineNumber="160"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/bookshelves_events.py" startLineNumber="165" endLineNumber="175"/>
            <text>
<![CDATA[        oldb = db.get_db()

        where_clause = 'id=$id'
        where_vars = {'id': pid}
        update_time = datetime.utcnow()

        return oldb.update(
            cls.TABLENAME,
            where=where_clause,
            vars=where_vars,
            updated=update_time,
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="26e7eaca7df11c3b3d33ed5bf4c85871">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="558" endLineNumber="566"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="570" endLineNumber="578"/>
            <text>
<![CDATA[        assert (
            next(
                iter(
                    self.db.select(
                        self.TABLENAME,
                        where={'username': '@billy_pilgrim', 'year': 2023},
                    )
                )
            )['current']
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="89cff0d8be05a2d56bcd8b5757fc6a63">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="180" endLineNumber="188"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_merge_authors.py" startLineNumber="204" endLineNumber="212"/>
            <text>
<![CDATA[            "key": "/works/OL2W",
            "authors": [
                {
                    "type": {"key": "/type/author_role"},
                    "author": {"key": "/authors/OL2A"},
                }
            ],
            "title": "book 1",
        }
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="bf11ba92bddf446d044500777a00735f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="583" endLineNumber="591"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="595" endLineNumber="603"/>
            <text>
<![CDATA[        assert (
            next(
                iter(
                    self.db.select(
                        self.TABLENAME,
                        where={'username': '@billy_pilgrim', 'year': 2023},
                    )
                )
            )['target']
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="7ab39a8a9280267c22631eb45465c46e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="144" endLineNumber="152"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="168" endLineNumber="176"/>
            <text>
<![CDATA[            'type': '/type/work',
        },  # The work
        {
            'key': '/authors/OL1A',
            'name': 'Test author',
            'type': '/type/author',
        },  # The author
    ]
    assert expected == things
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="4f0b7c35b696fe5a5f9c062c702b832a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1136" endLineNumber="1145"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1255" endLineNumber="1264"/>
            <text>
<![CDATA[    """
    author = {
        'type': {'key': '/type/author'},
        'name': 'John Smith',
        'key': '/authors/OL1A',
    }

    existing_work = {
        'authors': [{'author': '/authors/OL1A', 'type': {'key': '/type/author_role'}}],
        'key': '/works/OL1W',
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="446587dbb512273bd3a99545194774ca">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="73" endLineNumber="81"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_vendors.py" startLineNumber="122" endLineNumber="130"/>
            <text>
<![CDATA[        'Vietnam Travel Guide 2019 : Ho Chi Minh City - First Journey',
        '10 Tips For an Amazing Trip',
    ],
    [
        'Secrets of Adobe(r) Acrobat(r) 7. 150 Best Practices and Tips (Russian Edition)',
        'Secrets of Adobe Acrobat 7. 150 Best Practices and Tips',
        None,
    ],
    [
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="4b2ebe95ef4657dc5f84f1b0af47089d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="1088" endLineNumber="1097"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/account.py" startLineNumber="1109" endLineNumber="1118"/>
            <text>
<![CDATA[    path = "/account/loan-history"

    @require_login
    def GET(self):
        i = web.input(page=1)
        page = int(i.page)
        user = accounts.get_current_user()
        username = user['key'].split('/')[-1]
        mb = MyBooksTemplate(username, key='loan_history')
        loan_history_data = get_loan_history_data(page=page, mb=mb)
]]>
            </text>
        </set>
        <set lineCount="9" fingerprint="effd435a16ff6c7061ec03cefc835f96">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_listapi.py" startLineNumber="73" endLineNumber="82"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_listapi.py" startLineNumber="108" endLineNumber="117"/>
            <text>
<![CDATA[    api = ListAPI(config)
    api.login()

    data = {
        "name": "foo",
        "description": "foo bar",
        "tags": ["t1", "t2"],
        "seeds": ["subject:cheese"],
    }
    result = api.create_list(data)
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="db1d50fb4bce4325c2b02901093c11cf">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/publishers.py" startLineNumber="93" endLineNumber="105"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/languages.py" startLineNumber="112" endLineNumber="124"/>
            <text>
<![CDATA[        if isinstance(publish_year, list):
            q['publish_year'] = tuple(publish_year)  # range
        elif publish_year:
            q['publish_year'] = publish_year

        result = solr.select(q, facets=["has_fulltext"], rows=0)
        counts = {v.value: v.count for v in result["facets"]["has_fulltext"]}
        return counts.get('true')


def setup():
    subjects.SUBJECTS.append(
        subjects.SubjectMeta(
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="e2ffc42139dc52791ca4e8bdb2c851e2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="683" endLineNumber="692"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/code.py" startLineNumber="525" endLineNumber="534"/>
            <text>
<![CDATA[    def auth_failed(self, reason):
        d = json.dumps({"status": "error", "reason": reason})
        return web.HTTPError(
            "401 Authorization Required",
            {
                "WWW-Authenticate": 'Basic realm="http://openlibrary.org"',
                "Content-Type": "application/json",
            },
            d,
        )
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="e2eb64ae64ac21cb5cd7ca11810790ff">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="876" endLineNumber="887"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="838" endLineNumber="849"/>
            <text>
<![CDATA[        deleted_observations = _get_deleted_types_and_values()

        if len(deleted_observations['types']):
            deleted_type_ids = ', '.join(str(i) for i in deleted_observations['types'])
            query += f'AND observation_type not in ({deleted_type_ids}) '

        if len(deleted_observations['values']):
            for key in deleted_observations['values']:
                deleted_value_ids = ', '.join(
                    str(i) for i in deleted_observations['values'][key]
                )
                query += f'AND NOT (observation_type = {key} AND observation_value IN ({deleted_value_ids})) '
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="e8c812df685675401e9840b8807cdf26">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_related_carousels.py" startLineNumber="54" endLineNumber="63"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_related_carousels.py" startLineNumber="27" endLineNumber="36"/>
            <text>
<![CDATA[        "Multiple personality in fiction",
        "Conduct of life in fiction",
        "Supernatural in fiction",
        "Juvenile fiction",
        "History and criticism",
        "Horror tales",
        "English fiction",
        "Social conditions",
        "Horror stories",
        "Multiple personality",
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="5ea0b624fde12a2cd6690aab0a936ae6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/utils/__init__.py" startLineNumber="38" endLineNumber="47"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/helpers.py" startLineNumber="296" endLineNumber="305"/>
            <text>
<![CDATA[    """
    key = key or (lambda x: x)
    s = set()
    result = []
    for v in values:
        k = key(v)
        if k not in s:
            s.add(k)
            result.append(v)
    return result
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="f40803a7a01cbddd2efec4cfa31e70ef">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="303" endLineNumber="313"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="279" endLineNumber="288"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="232" endLineNumber="242"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="209" endLineNumber="219"/>
            <text>
<![CDATA[        b = ol.browser()

        self.signup(
            b,
            displayname="Foo",
            username="foo",
            password="secret",
            email="foo@example.com",
        )
        link = ol.sentmail.extract_links()[0]
        b.open(link)
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="b2d64d5aa7b7cbfcf35fb63132b1c161">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="881" endLineNumber="891"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1113" endLineNumber="1123"/>
            <text>
<![CDATA[    rec = {
        'source_records': 'non-marc:test',
        'title': 'Finding Existing Works',
        'authors': [{'name': 'John Smith'}],
        'publishers': ['Black Spot'],
        'publish_date': 'Jan 09, 2011',
        'isbn_10': ['1250144051'],
    }

    reply = load(rec)
    assert reply['success'] is True
]]>
            </text>
        </set>
        <set lineCount="10" fingerprint="b6dbbfbacda193adcc2d553e7e0fb2a8">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="76" endLineNumber="87"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/yearly_reading_goals.py" startLineNumber="58" endLineNumber="69"/>
            <text>
<![CDATA[        oldb = db.get_db()

        where = 'username=$username AND year=$year'
        data = {
            'username': username,
            'year': year,
        }

        return oldb.update(
            cls.TABLENAME,
            where=where,
            vars=data,
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="a166ab87e29a71feb5f883ee919f12e6">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1107" endLineNumber="1119"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1225" endLineNumber="1237"/>
            <text>
<![CDATA[    }

    mock_site.save(author)
    mock_site.save(existing_work)
    mock_site.save(existing_edition)

    rec = {
        'source_records': 'non-marc:test',
        'title': 'Finding Existing Works',
        'authors': [{'name': 'John Smith'}],
        'publishers': ['Black Spot'],
        'publish_date': 'Jan 09, 2011',
        'isbn_10': ['1250144051'],
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="49f7e93cac8f783f0ab8f2441b6a9cfb">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="454" endLineNumber="464"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="412" endLineNumber="422"/>
            <text>
<![CDATA[            'identifiers': {
                'isbn': ['1234567890'],
                'lccn': ['1230'],
                'ocaid': '123450',
                'oclc_numbers': ['4560'],
            },
            'key': '/books/OL1M',
            'title': 'test1',
            'type': '/type/edition',
            'work': {'key': '/works/OL1W'},
        },
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="08830de6837d61d23aec2323f9a2f13d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="279" endLineNumber="289"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_account.py" startLineNumber="303" endLineNumber="315"/>
            <text>
<![CDATA[        b = ol.browser()
        self.signup(
            b,
            displayname="Foo",
            username="foo",
            password="secret",
            email="foo@example.com",
        )

        link = ol.sentmail.extract_links()[0]
        b.open(link)

        self.login(b, "foo", "secret")
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="dc1a2594fcd99fc27ae776d1213c4daa">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="137" endLineNumber="147"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="302" endLineNumber="312"/>
            <text>
<![CDATA[    rec = {
        'ocaid': 'test_item',
        'source_records': ['ia:test_item'],
        'title': 'Test item',
        'languages': ['eng'],
    }
    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'created'
    e = mock_site.get(reply['edition']['key'])
    assert e.type.key == '/type/edition'
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="dc9217170756c51b786cfaa3b75a7174">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="233" endLineNumber="243"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="411" endLineNumber="421"/>
            <text>
<![CDATA[            'authors': [{'key': '/authors/OL1A'}, {'key': '/authors/OL2A'}],
            'identifiers': {
                'isbn': ['1234567890'],
                'lccn': ['1230'],
                'ocaid': '123450',
                'oclc_numbers': ['4560'],
            },
            'key': '/books/OL1M',
            'title': 'test1',
            'type': '/type/edition',
            'work': {'key': '/works/OL1W'},
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="2d79108974bba8251fa7e350808fe3fe">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="436" endLineNumber="446"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="460" endLineNumber="470"/>
            <text>
<![CDATA[            'key': '/books/OL1M',
            'title': 'test1',
            'type': '/type/edition',
            'work': {'key': '/works/OL1W'},
        },
        'matches': [
            {'edition': '/books/OL1M', 'work': '/works/OL1W'},
            {'edition': '/books/OL2M', 'work': '/works/OL1W'},
        ],
    }
    assert massaged == expected
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="7ed38f891add777c4d3ddb302a10b5ec">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="255" endLineNumber="268"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/models.py" startLineNumber="589" endLineNumber="601"/>
            <text>
<![CDATA[        Sample return values:

            {
                "read_url": "http://www.archive.org/stream/foo00bar",
                "daisy_url": "/books/OL1M/foo/daisy"
            }

            {
                "daisy_url": "/books/OL1M/foo/daisy",
                "borrow_url": "/books/OL1M/foo/borrow",
                "borrowed": False
            }
        """
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="877f87bbdeb5cf014c854dca0921a46d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="1084" endLineNumber="1095"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="868" endLineNumber="878"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="901" endLineNumber="911"/>
            <text>
<![CDATA[    author = {
        'type': {'key': '/type/author'},
        'name': 'John Smith',
        'key': '/authors/OL20A',
    }
    existing_work = {
        'authors': [{'author': '/authors/OL20A', 'type': {'key': '/type/author_role'}}],
        'key': '/works/OL16W',
        'title': 'Finding existing works',
        'type': {'key': '/type/work'},
    }
]]>
            </text>
        </set>
        <set lineCount="11" fingerprint="e430b83a4c045c2f867c49de16b46e73">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="402" endLineNumber="412"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_db.py" startLineNumber="445" endLineNumber="455"/>
            <text>
<![CDATA[        assert len(list(self.db.select('bookshelves_events'))) == 6
        assert (
            len(
                list(
                    self.db.select(
                        'bookshelves_events', where={"username": "@kilgore_trout"}
                    )
                )
            )
            == 3
        )
]]>
            </text>
        </set>
        <set lineCount="12" fingerprint="0ab4ededd4661dc7a09ec25695a6085f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_i18n.py" startLineNumber="33" endLineNumber="46"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_home.py" startLineNumber="25" endLineNumber="38"/>
            <text>
<![CDATA[        monkeypatch.setattr(web, "ctx", ctx)
        monkeypatch.setattr(web.webapi, "ctx", web.ctx)

        self._load_fake_context()
        web.ctx.lang = 'en'
        web.ctx.site = MockSite()

    def _load_fake_context(self):
        self.app = web.application()
        self.env = {
            "PATH_INFO": "/",
            "HTTP_METHOD": "GET",
        }
        self.app.load(self.env)
]]>
            </text>
        </set>
        <set lineCount="12" fingerprint="0a92c47093ed7ccda2aab9b5d41a048f">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="945" endLineNumber="959"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="870" endLineNumber="882"/>
            <text>
<![CDATA[        if spamcheck.is_spam(allow_privileged_edits=True):
            return render_template(
                "message.html", "Oops", 'Something went wrong. Please try again later.'
            )

        recap = get_recaptcha()
        if recap and not recap.validate():
            return render_template(
                "message.html",
                'Recaptcha solution was incorrect',
                'Please <a href="javascript:history.back()">go back</a> and try again.',
            )
        v = i.v and safeint(i.v, None)
]]>
            </text>
        </set>
        <set lineCount="12" fingerprint="221eeb8f321d8f564024c2bf31e5d20d">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/works.py" startLineNumber="142" endLineNumber="155"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/editions.py" startLineNumber="48" endLineNumber="61"/>
            <text>
<![CDATA[        'ebook_access': 'ebook_access desc',
        'ebook_access asc': 'ebook_access asc',
        'ebook_access desc': 'ebook_access desc',
        # Key
        'key': 'key asc',
        'key asc': 'key asc',
        'key desc': 'key desc',
        # Random
        'random': 'random_1 asc',
        'random asc': 'random_1 asc',
        'random desc': 'random_1 desc',
        'random.hourly': lambda: f'random_{datetime.now():%Y%m%dT%H} asc',
        'random.daily': lambda: f'random_{datetime.now():%Y%m%d} asc',
    }
]]>
            </text>
        </set>
        <set lineCount="12" fingerprint="9643be6b66dbb955967bafd51656f473">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="314" endLineNumber="326"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="278" endLineNumber="290"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="241" endLineNumber="253"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="204" endLineNumber="216"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="167" endLineNumber="179"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="134" endLineNumber="146"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="70" endLineNumber="82"/>
            <text>
<![CDATA[        monkeypatch.setattr(accounts, "get_current_user", mock_user)

        web.ctx.site.save_many(
            [
                {
                    "type": {"key": "/type/work"},
                    "key": "/works/OL1W",
                    "title": "Original Work Title",
                },
                {
                    "type": {"key": "/type/edition"},
                    "key": "/books/OL1M",
                    "title": "Original Edition Title",
]]>
            </text>
        </set>
        <set lineCount="13" fingerprint="c04bc210cd8bd0ccd2d23c66207c507a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="54" endLineNumber="66"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_vendors.py" startLineNumber="106" endLineNumber="118"/>
            <text>
<![CDATA[    ['Test Title', 'Test Title', None],
    [
        'Killers of the Flower Moon: The Osage Murders and the Birth of the FBI',
        'Killers of the Flower Moon',
        'The Osage Murders and the Birth of the FBI',
    ],
    ['Pachinko (National Book Award Finalist)', 'Pachinko', None],
    ['Trapped in a Video Game (Book 1) (Volume 1)', 'Trapped in a Video Game', None],
    [
        "An American Marriage (Oprah's Book Club): A Novel",
        'An American Marriage',
        'A Novel',
    ],
]]>
            </text>
        </set>
        <set lineCount="13" fingerprint="f762448623d73fb3dd6262f2fa80abb2">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="884" endLineNumber="897"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="918" endLineNumber="931"/>
            <text>
<![CDATA[        'authors': [{'name': 'John Smith'}],
        'publishers': ['Black Spot'],
        'publish_date': 'Jan 09, 2011',
        'isbn_10': ['1250144051'],
    }

    reply = load(rec)
    assert reply['success'] is True
    assert reply['edition']['status'] == 'created'
    assert reply['work']['status'] == 'matched'
    assert reply['work']['key'] == '/works/OL16W'
    assert reply['authors'][0]['status'] == 'matched'
    e = mock_site.get(reply['edition']['key'])
    assert e.works[0]['key'] == '/works/OL16W'
]]>
            </text>
        </set>
        <set lineCount="13" fingerprint="5a9fa3f00ec5fe51bd0d642861186e7a">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="387" endLineNumber="399"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/records/tests/test_functions.py" startLineNumber="433" endLineNumber="445"/>
            <text>
<![CDATA[    expected = {
        'doc': {
            'authors': [{'key': '/authors/OL1A'}, {'key': '/authors/OL2A'}],
            'key': '/books/OL1M',
            'title': 'test1',
            'type': '/type/edition',
            'work': {'key': '/works/OL1W'},
        },
        'matches': [
            {'edition': '/books/OL1M', 'work': '/works/OL1W'},
            {'edition': '/books/OL2M', 'work': '/works/OL1W'},
        ],
    }
]]>
            </text>
        </set>
        <set lineCount="13" fingerprint="a249755a644222d44950817afb8d3845">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/models.py" startLineNumber="918" endLineNumber="933"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/models.py" startLineNumber="937" endLineNumber="952"/>
            <text>
<![CDATA[    def can_undo(self):
        return self.get_undo_changeset() is None

    def get_master(self):
        master = self.data.get("master")
        return master and web.ctx.site.get(master, lazy=True)

    def get_duplicates(self):
        duplicates = self.data.get("duplicates")
        changes = {c['key']: c['revision'] for c in self.changes}

        return duplicates and [
            web.ctx.site.get(key, revision=changes[key] - 1, lazy=True)
            for key in duplicates
            if key in changes
        ]
]]>
            </text>
        </set>
        <set lineCount="13" fingerprint="7b9b210d6ddee9297882b77ee62d8f05">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addbook.py" startLineNumber="232" endLineNumber="246"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/addtag.py" startLineNumber="57" endLineNumber="71"/>
            <text>
<![CDATA[        if spamcheck.is_spam(i, allow_privileged_edits=True):
            return render_template(
                "message.html", "Oops", 'Something went wrong. Please try again later.'
            )

        if not web.ctx.site.get_user():
            recap = get_recaptcha()
            if recap and not recap.validate():
                return render_template(
                    'message.html',
                    'Recaptcha solution was incorrect',
                    'Please <a href="javascript:history.back()">go back</a> and try again.',
                )

        i = utils.unflatten(i)
]]>
            </text>
        </set>
        <set lineCount="13" fingerprint="08c7d5585fd56ff337bfa2f1db45695e">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/authors.py" startLineNumber="40" endLineNumber="53"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/subjects.py" startLineNumber="33" endLineNumber="46"/>
            <text>
<![CDATA[        'work_count',
    }
    facet_rewrites: dict[tuple[str, str], str | Callable[[], str]] = {}

    def q_to_solr_params(
        self,
        q: str,
        solr_fields: set[str],
        cur_solr_params: list[tuple[str, str]],
    ) -> list[tuple[str, str]]:
        return [
            ('q', q),
            ('q.op', 'AND'),
            ('defType', 'edismax'),
]]>
            </text>
        </set>
        <set lineCount="13" fingerprint="6f8e0a4f56d3fc9690e9d7e6b188eb45">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/coverstore/tests/test_webapp.py" startLineNumber="38" endLineNumber="52"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/books/tests/test_dynlinks.py" startLineNumber="202" endLineNumber="216"/>
            <text>
<![CDATA[class Mock:
    def __init__(self):
        self.calls = []
        self.default = None

    def __call__(self, *a, **kw):
        for a2, kw2, _return in self.calls:
            if (a, kw) == (a2, kw2):
                return _return
        return self.default

    def setup_call(self, *a, **kw):
        _return = kw.pop("_return", None)
        call = a, kw, _return
        self.calls.append(call)
]]>
            </text>
        </set>
        <set lineCount="14" fingerprint="8717fe7058d20ac5dccbf7fb0e0d5ad4">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="159" endLineNumber="172"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/marc/tests/test_get_subjects.py" startLineNumber="64" endLineNumber="77"/>
            <text>
<![CDATA[        {
            'person': {'William Vaughn Tupper (1835-1898)': 1},
            'subject': {
                'Photographs': 4,
                'Sources': 1,
                'Description and travel': 2,
                'Travel': 1,
                'History': 1,
                'Travel photography': 1,
            },
            'place': {'Europe': 3, 'Egypt': 2},
            'time': {'19th century': 1},
        },
    ),
]]>
            </text>
        </set>
        <set lineCount="15" fingerprint="6ea4c9b17a6e1f2e2683fa0c37688902">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_vendors.py" startLineNumber="219" endLineNumber="233"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/core/test_vendors.py" startLineNumber="237" endLineNumber="251"/>
            <text>
<![CDATA[        'url': 'https://www.amazon.com/dp/059035342X/?tag=internetarchi-20',
        'source_records': ['amazon:059035342X'],
        'isbn_10': ['059035342X'],
        'isbn_13': ['9780590353427'],
        'price': '$5.10',
        'price_amt': 509,
        'title': "Harry Potter and the Sorcerer's Stone",
        'cover': 'https://m.media-amazon.com/images/I/51Wbz5GypgL._SL500_.jpg',
        'authors': [{'name': 'Rowling, J.K.'}, {'name': 'GrandPr_, Mary'}],
        'publishers': ['Scholastic'],
        'number_of_pages': 309,
        'edition_num': '1',
        'publish_date': 'Sep 02, 1998',
        'product_group': 'Book',
        'physical_format': 'paperback',
]]>
            </text>
        </set>
        <set lineCount="15" fingerprint="b1bc41acf1ec431a2149a1c20de7eedb">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/authors.py" startLineNumber="20" endLineNumber="35"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/worksearch/schemes/subjects.py" startLineNumber="16" endLineNumber="31"/>
            <text>
<![CDATA[        'work_count',
    }
    facet_fields: set[str] = set()
    field_name_map: dict[str, str] = {}
    sorts = {
        'work_count desc': 'work_count desc',
        # Random
        'random': 'random_1 asc',
        'random asc': 'random_1 asc',
        'random desc': 'random_1 desc',
        'random.hourly': lambda: f'random_{datetime.now():%Y%m%dT%H} asc',
        'random.daily': lambda: f'random_{datetime.now():%Y%m%d} asc',
    }
    default_fetched_fields = {
        'key',
        'name',
]]>
            </text>
        </set>
        <set lineCount="16" fingerprint="9efe575753c6c40909fa138b5ba04bee">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="105" endLineNumber="122"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="41" endLineNumber="58"/>
            <text>
<![CDATA[        monkeypatch.setattr(accounts, "get_current_user", mock_user)

        web.ctx.site.save_many(
            [
                {
                    "type": {"key": "/type/edition"},
                    "key": "/books/OL1M",
                    "title": "Original Edition Title",
                }
            ]
        )
        edition = web.ctx.site.get("/books/OL1M")

        formdata = web.storage(
            {
                "work--key": "",
                "work--title": "Original Edition Title",
                "edition--title": "Original Edition Title",
]]>
            </text>
        </set>
        <set lineCount="16" fingerprint="c701c8ae1153fd2cc2009bafb2a7c1bf">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="901" endLineNumber="916"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/catalog/add_book/tests/test_add_book.py" startLineNumber="868" endLineNumber="883"/>
            <text>
<![CDATA[    author = {
        'type': {'key': '/type/author'},
        'name': 'John Smith',
        'key': '/authors/OL20A',
    }
    existing_work = {
        'authors': [{'author': '/authors/OL20A', 'type': {'key': '/type/author_role'}}],
        'key': '/works/OL16W',
        'title': 'Finding existing works',
        'type': {'key': '/type/work'},
    }
    mock_site.save(author)
    mock_site.save(existing_work)
    rec = {
        'source_records': 'non-marc:test',
        'title': 'Finding Existing Works',
]]>
            </text>
        </set>
        <set lineCount="16" fingerprint="9cfd79445704789d0327ce03ef942208">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="314" endLineNumber="330"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="278" endLineNumber="294"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="241" endLineNumber="257"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="204" endLineNumber="220"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="167" endLineNumber="183"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="70" endLineNumber="86"/>
            <text>
<![CDATA[        monkeypatch.setattr(accounts, "get_current_user", mock_user)

        web.ctx.site.save_many(
            [
                {
                    "type": {"key": "/type/work"},
                    "key": "/works/OL1W",
                    "title": "Original Work Title",
                },
                {
                    "type": {"key": "/type/edition"},
                    "key": "/books/OL1M",
                    "title": "Original Edition Title",
                    "works": [{"key": "/works/OL1W"}],
                },
            ]
        )
]]>
            </text>
        </set>
        <set lineCount="17" fingerprint="a1cd066e5873196cbdb2105875807499">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_opds.py" startLineNumber="17" endLineNumber="37"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/importapi/import_rdf.py" startLineNumber="36" endLineNumber="56"/>
            <text>
<![CDATA[def parse_category(e, key):
    return (key, e.get('label'))


def parse_identifier(e, key):
    val = e.text
    isbn_str = 'urn:ISBN:'
    ia_str = 'http://www.archive.org/details/'
    if val.startswith(isbn_str):
        isbn = val[len(isbn_str) :]
        if len(isbn) == 10:
            return ('isbn_10', isbn)
        elif len(isbn) == 13:
            return ('isbn_13', isbn)
    elif val.startswith(ia_str):
        return ('ocaid', val[len(ia_str) :])
    else:
        return (None, None)


parser_map = {
]]>
            </text>
        </set>
        <set lineCount="18" fingerprint="0de0c0042f172a3ba19c3fec03ab8e1c">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_data_provider.py" startLineNumber="35" endLineNumber="52"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/tests/solr/test_data_provider.py" startLineNumber="12" endLineNumber="29"/>
            <text>
<![CDATA[        mock_site = MagicMock()
        dp = BetterDataProvider(
            site=mock_site,
            db=MagicMock(),
        )
        mock_site.get_many.return_value = [
            Thing(
                mock_site,
                '/works/OL1W',
                {
                    'key': '/works/OL1W',
                    'type': {'key': '/type/work'},
                },
            )
        ]
        assert mock_site.get_many.call_count == 0
        await dp.get_document('/works/OL1W')
        assert mock_site.get_many.call_count == 1
]]>
            </text>
        </set>
        <set lineCount="21" fingerprint="666171e369e24de64c349b0046c04c57">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_listapi.py" startLineNumber="14" endLineNumber="39"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/openlibrary/tests/test_ratingsapi.py" startLineNumber="16" endLineNumber="41"/>
            <text>
<![CDATA[    def __init__(self, config):
        self.server = config.getvalue('server')
        self.username = config.getvalue("username")
        self.password = config.getvalue("password")

        self.cookiejar = cookielib.CookieJar()

        self.opener = urllib.request.build_opener()
        self.opener.add_handler(urllib.request.HTTPCookieProcessor(self.cookiejar))

    def urlopen(self, path, data=None, method=None, headers=None):
        headers = headers or {}
        """url open with cookie support."""
        if not method:
            if data:
                method = "POST"
            else:
                method = "GET"

        req = urllib.request.Request(self.server + path, data=data, headers=headers)
        req.get_method = lambda: method
        return self.opener.open(req)

    def login(self):
        data = {'username': self.username, 'password': self.password}
        self.urlopen("/account/login", data=urllib.parse.urlencode(data), method="POST")
]]>
            </text>
        </set>
        <set lineCount="22" fingerprint="140a7b580ea287a9dccc3c69defd45e0">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="314" endLineNumber="338"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="241" endLineNumber="265"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="167" endLineNumber="191"/>
            <text>
<![CDATA[        monkeypatch.setattr(accounts, "get_current_user", mock_user)

        web.ctx.site.save_many(
            [
                {
                    "type": {"key": "/type/work"},
                    "key": "/works/OL1W",
                    "title": "Original Work Title",
                },
                {
                    "type": {"key": "/type/edition"},
                    "key": "/books/OL1M",
                    "title": "Original Edition Title",
                    "works": [{"key": "/works/OL1W"}],
                },
            ]
        )

        work = web.ctx.site.get("/works/OL1W")
        edition = web.ctx.site.get("/books/OL1M")

        formdata = web.storage(
            {
                "work--key": "/works/OL1W",
                "work--title": "Modified Work Title",
]]>
            </text>
        </set>
        <set lineCount="22" fingerprint="32995f85806bef1de11215104a38ebe1">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="278" endLineNumber="302"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="204" endLineNumber="228"/>
            <text>
<![CDATA[        monkeypatch.setattr(accounts, "get_current_user", mock_user)

        web.ctx.site.save_many(
            [
                {
                    "type": {"key": "/type/work"},
                    "key": "/works/OL1W",
                    "title": "Original Work Title",
                },
                {
                    "type": {"key": "/type/edition"},
                    "key": "/books/OL1M",
                    "title": "Original Edition Title",
                    "works": [{"key": "/works/OL1W"}],
                },
            ]
        )

        work = web.ctx.site.get("/works/OL1W")
        edition = web.ctx.site.get("/books/OL1M")

        formdata = web.storage(
            {
                "work--key": "/works/OL1W",
                "work--title": "Original Work Title",
]]>
            </text>
        </set>
        <set lineCount="23" fingerprint="dd3889a557dda38077987868fa0f60ed">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="167" endLineNumber="192"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/plugins/upstream/tests/test_addbook.py" startLineNumber="314" endLineNumber="339"/>
            <text>
<![CDATA[        monkeypatch.setattr(accounts, "get_current_user", mock_user)

        web.ctx.site.save_many(
            [
                {
                    "type": {"key": "/type/work"},
                    "key": "/works/OL1W",
                    "title": "Original Work Title",
                },
                {
                    "type": {"key": "/type/edition"},
                    "key": "/books/OL1M",
                    "title": "Original Edition Title",
                    "works": [{"key": "/works/OL1W"}],
                },
            ]
        )

        work = web.ctx.site.get("/works/OL1W")
        edition = web.ctx.site.get("/books/OL1M")

        formdata = web.storage(
            {
                "work--key": "/works/OL1W",
                "work--title": "Modified Work Title",
                "edition--title": "Original Edition Title",
]]>
            </text>
        </set>
        <set lineCount="24" fingerprint="944217f12abb6a5c7affe9a98c3c9696">
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="294" endLineNumber="317"/>
            <block sourceFile="/home/leander/PycharmProjects/openlibrary/openlibrary/core/observations.py" startLineNumber="188" endLineNumber="211"/>
            <text>
<![CDATA[                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20,
                21,
                22,
                23,
                24,
                25,
                26,
]]>
            </text>
        </set>
        <summary duplicateFileCount="135" duplicateLineCount="4612" duplicateBlockCount="774" totalFileCount="317" totalRawLineCount="62014" totalSignificantLineCount="49255" processingTime="304"/>
    </check>
</simian>
